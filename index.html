<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T·ª´ v·ª±ng 30 m·ª•c ‚Äî file ƒë∆°n</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box}
    :root{
      --primary:#3b82f6;--primary-dark:#1d4ed8;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --bg:#ffffff;--bg-secondary:#f8fafc;--bg-tertiary:#f1f5f9;
      --fg:#0f172a;--fg-secondary:#475569;--fg-muted:#64748b;
      --border:#e2e8f0;--border-hover:#cbd5e1;
      --shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --gradient:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    [data-theme="dark"]{
      --bg:#0f172a;--bg-secondary:#1e293b;--bg-tertiary:#334155;
      --fg:#f8fafc;--fg-secondary:#cbd5e1;--fg-muted:#94a3b8;
      --border:#334155;--border-hover:#475569;
      --shadow:0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
    }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:"Noto Sans","Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Arial;transition:all 0.3s ease;line-height:1.6}
    
    /* Header */
    header{background:var(--gradient);color:white;padding:2rem 1rem;text-align:center;position:relative;overflow:hidden}
    header::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');opacity:0.3}
    h1{margin:0 0 0.5rem 0;font-size:clamp(1.8rem,4vw,2.5rem);font-weight:700;position:relative;z-index:1}
    .sub{margin:0;opacity:0.9;font-size:1.1rem;position:relative;z-index:1}
    
    /* Navigation */
    .nav{background:var(--bg);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;backdrop-filter:blur(10px);box-shadow:var(--shadow)}
    .nav-content{max-width:1200px;margin:0 auto;padding:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    
    /* Theme Toggle */
    .theme-toggle{background:var(--bg-secondary);border:1px solid var(--border);border-radius:50px;padding:0.5rem;cursor:pointer;display:flex;align-items:center;gap:0.5rem;transition:all 0.3s ease;min-width:auto}
    .theme-toggle:hover{background:var(--bg-tertiary);border-color:var(--border-hover)}
    
    /* Controls */
    .controls{background:var(--bg-secondary);margin:1rem;border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    input[type=search]{flex:1;min-width:280px;padding:0.75rem 1rem;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--fg);font-size:1rem;transition:all 0.3s ease}
    input[type=search]:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgb(59 130 246 / 0.1)}
    
    /* Buttons */
    button{border:2px solid var(--border);background:var(--bg);color:var(--fg);border-radius:10px;padding:0.75rem 1.5rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:0.5rem;font-size:0.95rem}
    button:hover{border-color:var(--primary);color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow)}
    button:active{transform:translateY(0)}
    .btn-primary{background:var(--primary);color:white;border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-dark);border-color:var(--primary-dark);color:white}
    
    /* Main Content */
    main{max-width:1200px;margin:0 auto;padding:1rem}
    .card{background:var(--bg);border-radius:12px;box-shadow:var(--shadow);margin-bottom:2rem}
    .table-container{overflow:auto;border-radius:12px}
    
    /* Table */
    table{width:100%;border-collapse:collapse}
    thead{background:var(--bg-secondary)}
    thead th{padding:1rem;text-align:left;font-weight:600;color:var(--fg-secondary);border-bottom:2px solid var(--border);position:sticky;top:0;z-index:10;background:var(--bg-secondary)}
    tbody td{padding:1rem;border-bottom:1px solid var(--border);vertical-align:top;transition:all 0.2s ease}
    tbody tr:hover{background:var(--bg-secondary);transform:scale(1.01)}
    .idx{width:60px;color:var(--fg-muted);font-weight:600}
    .chinese{font-size:1.4rem;font-weight:600;color:var(--primary)}
    .pinyin{font-style:italic;color:var(--fg-secondary);font-size:1.1rem}
    .vietnamese{font-size:1rem}
    
    /* Study Tools */
    .study-tools{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}
    .tool-card{background:var(--bg);border:2px solid var(--border);border-radius:12px;padding:1.5rem;flex:1;min-width:250px;text-align:center;cursor:pointer;transition:all 0.3s ease}
    .tool-card:hover{border-color:var(--primary);transform:translateY(-4px);box-shadow:var(--shadow-lg)}
    .tool-icon{font-size:2rem;margin-bottom:0.5rem}
    .tool-title{font-weight:600;margin-bottom:0.25rem}
    .tool-desc{color:var(--fg-muted);font-size:0.9rem}
    
    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
    .stat-card{background:var(--bg);border-radius:12px;padding:1.5rem;text-align:center;box-shadow:var(--shadow);border-left:4px solid var(--primary)}
    .stat-number{font-size:2rem;font-weight:700;color:var(--primary);margin-bottom:0.25rem}
    .stat-label{color:var(--fg-muted);font-size:0.9rem}
    
    /* Responsive */
    @media (max-width: 768px){
      .nav-content,.controls{flex-direction:column;align-items:stretch}
      input[type=search]{min-width:auto}
      .study-tools{flex-direction:column}
      table{font-size:0.9rem}
      thead th,tbody td{padding:0.75rem 0.5rem}
      .chinese{font-size:1.2rem}
      .modal-header{flex-direction:column;gap:1rem}
      .modal-header > div{justify-content:center}
      #quizOptions{font-size:0.9rem}
    }
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn 0.5s ease-out}
    
    @keyframes pulse{
      0%{transform:scale(1)}
      50%{transform:scale(1.1)}
      100%{transform:scale(1)}
    }
    
    @keyframes slideInRight{
      from{transform:translateX(100%);opacity:0}
      to{transform:translateX(0);opacity:1}
    }
    
    @keyframes slideOutRight{
      from{transform:translateX(0);opacity:1}
      to{transform:translateX(100%);opacity:0}
    }
    
    @keyframes bounceIn{
      0%{transform:scale(0.3);opacity:0}
      50%{transform:scale(1.05)}
      70%{transform:scale(0.9)}
      100%{transform:scale(1);opacity:1}
    }
    
    @keyframes glow{
      0%,100%{box-shadow:0 0 5px rgba(59,130,246,0.3)}
      50%{box-shadow:0 0 20px rgba(59,130,246,0.6)}
    }
    
    /* Modal with Glassmorphism */
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(10px)}
    .modal-content{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:20px;
      padding:2rem;
      max-width:500px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
      box-shadow:0 20px 40px rgba(0,0,0,0.15);
      animation:bounceIn 0.5s ease-out;
    }
    [data-theme="dark"] .modal-content{
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(255,255,255,0.1);
    }
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
    .modal-title{font-size:1.5rem;font-weight:700;margin:0}
    .close-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--fg-muted);padding:0.5rem;border-radius:50%;transition:all 0.3s ease}
    .close-btn:hover{color:var(--danger);background:rgba(239,68,68,0.1);transform:scale(1.1)}

    /* Toast Notifications */
    .toast-container{
      position:fixed;
      top:1rem;
      right:1rem;
      z-index:2000;
      max-width:400px;
      pointer-events:none;
    }
    
    .toast{
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:12px;
      margin-bottom:0.5rem;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
      transform:translateX(100%);
      opacity:0;
      transition:all 0.3s ease;
      pointer-events:auto;
      overflow:hidden;
      position:relative;
    }
    
    .toast.show{
      transform:translateX(0);
      opacity:1;
      animation:slideInRight 0.3s ease-out;
    }
    
    .toast-content{
      display:flex;
      align-items:center;
      padding:1rem;
      gap:0.75rem;
    }
    
    .toast-icon{
      font-size:1.2rem;
      flex-shrink:0;
    }
    
    .toast-message{
      flex:1;
      font-weight:500;
      color:var(--fg);
    }
    
    .toast-close{
      background:none;
      border:none;
      font-size:1.2rem;
      cursor:pointer;
      color:var(--fg-muted);
      padding:0.25rem;
      border-radius:50%;
      transition:all 0.2s ease;
      flex-shrink:0;
    }
    
    .toast-close:hover{
      background:rgba(0,0,0,0.1);
      color:var(--fg);
    }
    
    .toast-success{border-left:4px solid var(--success)}
    .toast-error{border-left:4px solid var(--danger)}
    .toast-warning{border-left:4px solid var(--warning)}
    .toast-info{border-left:4px solid var(--primary)}
    
    [data-theme="dark"] .toast{
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(255,255,255,0.1);
    }

    /* Glassmorphism Cards */
    .glass-card{
      background:rgba(255,255,255,0.1);
      backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:20px;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
    }
    
    [data-theme="dark"] .glass-card{
      background:rgba(15,23,42,0.2);
      border:1px solid rgba(255,255,255,0.1);
    }

    /* Enhanced Stats Cards */
    .stat-card{
      background:rgba(255,255,255,0.8);
      backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.3);
      border-radius:20px;
      padding:1.5rem;
      text-align:center;
      box-shadow:0 8px 32px rgba(0,0,0,0.1);
      border-left:4px solid var(--primary);
      transition:all 0.3s ease;
      position:relative;
      overflow:hidden;
    }
    
    .stat-card:hover{
      transform:translateY(-5px);
      box-shadow:0 12px 40px rgba(0,0,0,0.15);
      border-left-width:6px;
    }
    
    .stat-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:2px;
      background:var(--gradient);
      opacity:0;
      transition:opacity 0.3s ease;
    }
    
    .stat-card:hover::before{
      opacity:1;
    }
    
    [data-theme="dark"] .stat-card{
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(255,255,255,0.1);
    }

    /* Enhanced Study Tools */
    .tool-card{
      background:rgba(255,255,255,0.8);
      backdrop-filter:blur(20px);
      border:2px solid rgba(255,255,255,0.3);
      border-radius:20px;
      padding:2rem 1.5rem;
      flex:1;
      min-width:250px;
      text-align:center;
      cursor:pointer;
      transition:all 0.4s ease;
      position:relative;
      overflow:hidden;
    }
    
    .tool-card::before{
      content:'';
      position:absolute;
      top:-50%;
      left:-50%;
      width:200%;
      height:200%;
      background:conic-gradient(from 0deg, transparent, rgba(59,130,246,0.1), transparent);
      opacity:0;
      transition:all 0.4s ease;
    }
    
    .tool-card:hover{
      border-color:var(--primary);
      transform:translateY(-8px) scale(1.02);
      box-shadow:0 20px 40px rgba(59,130,246,0.15);
      animation:glow 2s infinite;
    }
    
    .tool-card:hover::before{
      opacity:1;
      animation:spin 2s linear infinite;
    }
    
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    
    [data-theme="dark"] .tool-card{
      background:rgba(15,23,42,0.8);
      border:2px solid rgba(255,255,255,0.1);
    }

    /* Progress Ring */
    .progress-ring{
      width:100px;
      height:100px;
      margin:0 auto;
    }
    
    .progress-ring-circle{
      transition:stroke-dashoffset 0.5s ease;
      transform:rotate(-90deg);
      transform-origin:50% 50%;
    }
    
    .progress-text{
      font-size:1.2rem;
      font-weight:700;
      fill:var(--primary);
    }

    /* Floating Action Button */
    .floating-action-btn{
      position:fixed;
      bottom:2rem;
      right:2rem;
      width:60px;
      height:60px;
      border-radius:50%;
      background:var(--gradient);
      border:none;
      color:white;
      font-size:1.5rem;
      cursor:pointer;
      box-shadow:0 8px 25px rgba(59,130,246,0.3);
      transition:all 0.3s ease;
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .floating-action-btn:hover{
      transform:scale(1.1) rotate(15deg);
      box-shadow:0 12px 35px rgba(59,130,246,0.4);
    }

    /* Writing Practice Canvas */
    .writing-practice{
      text-align:center;
      padding:2rem;
    }
    
    .target-character{
      font-size:4rem;
      color:var(--primary);
      margin-bottom:1rem;
      font-weight:700;
    }
    
    #writingCanvas{
      border:2px solid var(--border);
      border-radius:12px;
      margin-bottom:1rem;
      background:var(--bg);
      cursor:crosshair;
    }
    
    .writing-controls{
      display:flex;
      gap:1rem;
      justify-content:center;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>
  <header>
    <h1>üìö T·ª´ v·ª±ng Trung-Vi·ªát</h1>
    <p class="sub">·ª®ng d·ª•ng h·ªçc t·ª´ v·ª±ng ti·∫øng Trung v·ªõi nhi·ªÅu t√≠nh nƒÉng th√¥ng minh</p>
  </header>
  
  <nav class="nav">
    <div class="nav-content">
      <button class="theme-toggle" id="themeToggle">
        <span id="themeIcon">üåô</span>
        <span id="themeText">Ch·∫ø ƒë·ªô t·ªëi</span>
      </button>
    </div>
  </nav>

  <main>
    <!-- Enhanced Stats -->
    <div class="stats fade-in">
      <div class="stat-card">
        <div class="stat-number" id="totalWords">30</div>
        <div class="stat-label">T·ªïng t·ª´ v·ª±ng</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="studiedWords">0</div>
        <div class="stat-label">ƒê√£ h·ªçc</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="favoriteWords">0</div>
        <div class="stat-label">Y√™u th√≠ch</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="accuracy">0%</div>
        <div class="stat-label">ƒê·ªô ch√≠nh x√°c</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="currentStreak">0</div>
        <div class="stat-label">üî• Streak hi·ªán t·∫°i</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="dailyProgress">0/15</div>
        <div class="stat-label">üéØ M·ª•c ti√™u h√¥m nay</div>
      </div>
    </div>

    <!-- Enhanced Study Tools -->
    <div class="study-tools fade-in">
      <div class="tool-card" onclick="openFlashcards()">
        <div class="tool-icon">üóÇÔ∏è</div>
        <div class="tool-title">Flashcard</div>
        <div class="tool-desc">H·ªçc t·ª´ v·ª±ng v·ªõi th·∫ª ghi nh·ªõ</div>
      </div>
      <div class="tool-card" onclick="openQuiz()">
        <div class="tool-icon">üß†</div>
        <div class="tool-title">Ki·ªÉm tra SRS</div>
        <div class="tool-desc">Quiz th√¥ng minh v·ªõi thu·∫≠t to√°n l·∫∑p l·∫°i</div>
      </div>
      <div class="tool-card" onclick="openWritingPractice()">
        <div class="tool-icon">‚úçÔ∏è</div>
        <div class="tool-title">Luy·ªán vi·∫øt</div>
        <div class="tool-desc">Vi·∫øt ch·ªØ H√°n tr√™n canvas</div>
      </div>
      <div class="tool-card" onclick="openSRSReview()">
        <div class="tool-icon">üìÖ</div>
        <div class="tool-title">√în t·∫≠p SRS</div>
        <div class="tool-desc" id="dueWordsCount">0 t·ª´ c·∫ßn √¥n</div>
      </div>
    </div>

    <!-- Search Controls -->
    <div class="controls fade-in">
      <input id="q" type="search" placeholder="üîç T√¨m ki·∫øm: Ë¢´ / bei / 'n·ªó l·ª±c'‚Ä¶" autofocus />
      <button id="export">üì• Xu·∫•t CSV</button>
      <button id="clear">üóëÔ∏è X√≥a t√¨m</button>
      <button id="randomBtn">üé≤ Ng·∫´u nhi√™n</button>
      <div id="audioTip" style="background:var(--bg-tertiary);color:var(--fg-secondary);padding:0.5rem 1rem;border-radius:8px;font-size:0.9rem;display:none">
        üí° <strong>M·∫πo:</strong> Tr√™n ƒëi·ªán tho·∫°i, h√£y ch·∫°m v√†o n√∫t üîä ƒë·ªÉ ph√°t √¢m t·ª´ v·ª±ng ti·∫øng Trung
      </div>
    </div>

    <!-- Vocabulary Table -->
    <div class="card fade-in">
      <div class="table-container">
        <table id="tbl">
          <thead>
            <tr>
              <th class="idx">#</th>
              <th>ÁπÅÈ´î</th>
              <th>Pinyin</th>
              <th>Nghƒ©a ti·∫øng Vi·ªát</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Flashcard Modal -->
  <div class="modal" id="flashcardModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üóÇÔ∏è Flashcard</h2>
        <button class="close-btn" onclick="closeModal('flashcardModal')">&times;</button>
      </div>
      <div id="flashcardContent">
        <div style="text-align:center;padding:2rem">
          <div id="flashcardChinese" style="font-size:3rem;margin-bottom:1rem;color:var(--primary)"></div>
          <div id="flashcardPinyin" style="font-size:1.5rem;color:var(--fg-secondary);margin-bottom:1rem;display:none"></div>
          <div id="flashcardVietnamese" style="font-size:1.2rem;display:none"></div>
          <div style="margin-top:2rem;display:flex;gap:1rem;justify-content:center">
            <button id="revealBtn" class="btn-primary">Hi·ªán ƒë√°p √°n</button>
            <button id="nextCardBtn" style="display:none">T·ª´ ti·∫øp theo</button>
            <button onclick="speakChinese()" style="background:var(--success);color:white;border-color:var(--success)">üîä Ph√°t √¢m</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div class="modal" id="quizModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üß† Ki·ªÉm tra t·ª´ v·ª±ng</h2>
        <div style="display:flex;gap:1rem;align-items:center">
          <div style="background:var(--bg-secondary);padding:0.5rem 1rem;border-radius:6px;font-size:0.9rem">
            Ti·∫øn ƒë·ªô: <span id="quizProgress" style="font-weight:600;color:var(--primary)">0/30</span>
          </div>
          <button onclick="resetQuiz()" style="background:var(--warning);color:white;border:none;border-radius:6px;padding:0.5rem;font-size:0.9rem;cursor:pointer" title="B·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu">
            üîÑ
          </button>
          <button class="close-btn" onclick="closeModal('quizModal')">&times;</button>
        </div>
      </div>
      <div id="quizContent">
        <div id="quizQuestion" style="text-align:center;padding:2rem">
          <div id="quizChinese" style="font-size:2.5rem;margin-bottom:1rem;color:var(--primary)"></div>
          <div id="quizPinyin" style="font-size:1.2rem;color:var(--fg-secondary);margin-bottom:2rem"></div>
          <div id="quizOptions" style="display:grid;gap:1rem;max-width:400px;margin:0 auto"></div>
          <div id="quizResult" style="margin-top:1rem;display:none"></div>
          <div style="margin-top:2rem">
            <button id="nextQuestionBtn" style="display:none" class="btn-primary">C√¢u ti·∫øp theo</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Writing Practice Modal -->
  <div class="modal" id="writingModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">‚úçÔ∏è Luy·ªán vi·∫øt ch·ªØ H√°n</h2>
        <button class="close-btn" onclick="closeModal('writingModal')">&times;</button>
      </div>
      <div class="writing-practice">
        <div class="target-character" id="targetCharacter">Ë¢´</div>
        <div style="margin-bottom:1rem">
          <span style="color:var(--fg-secondary)">H√£y vi·∫øt ch·ªØ n√†y:</span>
        </div>
        <canvas id="writingCanvas" width="300" height="300"></canvas>
        <div class="writing-controls">
          <button onclick="clearCanvas()" style="background:var(--danger);color:white;border-color:var(--danger)">
            üóëÔ∏è X√≥a
          </button>
          <button onclick="showStrokeOrder()" style="background:var(--warning);color:white;border-color:var(--warning)">
            üí° Stroke Order
          </button>
          <button onclick="nextWritingCharacter()" class="btn-primary">
            ‚û°Ô∏è T·ª´ ti·∫øp theo
          </button>
        </div>
        <div id="writingFeedback" style="margin-top:1rem;display:none"></div>
      </div>
    </div>
  </div>

  <!-- SRS Review Modal -->
  <div class="modal" id="srsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">üìÖ √în t·∫≠p SRS</h2>
        <div style="display:flex;gap:1rem;align-items:center">
          <div style="background:var(--bg-secondary);padding:0.5rem 1rem;border-radius:6px;font-size:0.9rem">
            C√≤n l·∫°i: <span id="srsRemaining" style="font-weight:600;color:var(--primary)">0</span>
          </div>
          <button class="close-btn" onclick="closeModal('srsModal')">&times;</button>
        </div>
      </div>
      <div id="srsContent">
        <div id="srsQuestion" style="text-align:center;padding:2rem">
          <div id="srsChinese" style="font-size:3rem;margin-bottom:1rem;color:var(--primary)"></div>
          <div id="srsPinyin" style="font-size:1.5rem;color:var(--fg-secondary);margin-bottom:1rem;display:none"></div>
          <div id="srsVietnamese" style="font-size:1.2rem;display:none"></div>
          <div style="margin-top:2rem;display:flex;gap:1rem;justify-content:center;flex-wrap:wrap">
            <button id="srsRevealBtn" class="btn-primary">Hi·ªán ƒë√°p √°n</button>
            <button onclick="speakChinese()" style="background:var(--success);color:white;border-color:var(--success)">üîä Ph√°t √¢m</button>
          </div>
          <div id="srsRating" style="margin-top:2rem;display:none">
            <p style="margin-bottom:1rem;color:var(--fg-secondary)">ƒê√°nh gi√° ƒë·ªô kh√≥ c·ªßa t·ª´ n√†y:</p>
            <div style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap">
              <button onclick="rateSRS(1)" style="background:var(--danger);color:white;border-color:var(--danger)">
                üò∞ Kh√≥
              </button>
              <button onclick="rateSRS(3)" style="background:var(--warning);color:white;border-color:var(--warning)">
                ü§î B√¨nh th∆∞·ªùng
              </button>
              <button onclick="rateSRS(5)" style="background:var(--success);color:white;border-color:var(--success)">
                üòä D·ªÖ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button class="floating-action-btn" onclick="showQuickActions()" title="Quick Actions">
    ‚ö°
  </button>

  <script>
    const DATA = [{"ÁπÅÈ´î":"Ë¢´","Pinyin":"b√®i","Nghƒ©a ti·∫øng Vi·ªát":"b·ªã (b·ªã ƒë·ªông)"},{"ÁπÅÈ´î":"ÈÅäÊà≤","Pinyin":"y√≥ux√¨","Nghƒ©a ti·∫øng Vi·ªát":"tr√≤ ch∆°i"},{"ÁπÅÈ´î":"ÂêÉÂÖâ‰∫Ü","Pinyin":"chƒ´ guƒÅng le","Nghƒ©a ti·∫øng Vi·ªát":"ƒÉn h·∫øt r·ªìi"},{"ÁπÅÈ´î":"ÂÖ∂‰ªñÂú∞Êñπ","Pinyin":"q√≠tƒÅ d√¨fƒÅng","Nghƒ©a ti·∫øng Vi·ªát":"n∆°i kh√°c"},{"ÁπÅÈ´î":"Êê¨‰∏ç‰∫Ü","Pinyin":"bƒÅn b√π li«éo","Nghƒ©a ti·∫øng Vi·ªát":"kh√¥ng d·ªçn\/kh√¥ng mang ƒë∆∞·ª£c"},{"ÁπÅÈ´î":"ÂÖ¨ÂØì","Pinyin":"g≈çngy√π","Nghƒ©a ti·∫øng Vi·ªát":"cƒÉn h·ªô"},{"ÁπÅÈ´î":"ÊóÖÈÅä","Pinyin":"l«öy√≥u","Nghƒ©a ti·∫øng Vi·ªát":"du l·ªãch"},{"ÁπÅÈ´î":"ËààË∂£","Pinyin":"x√¨ngq√π","Nghƒ©a ti·∫øng Vi·ªát":"h·ª©ng th√∫, s·ªü th√≠ch"},{"ÁπÅÈ´î":"Êéâ","Pinyin":"di√†o","Nghƒ©a ti·∫øng Vi·ªát":"r∆°i, m·∫•t"},{"ÁπÅÈ´î":"Á∑äÂºµ‰∫Ü","Pinyin":"j«ênzhƒÅng le","Nghƒ©a ti·∫øng Vi·ªát":"cƒÉng th·∫≥ng r·ªìi"},{"ÁπÅÈ´î":"Â∞èÂøÉ","Pinyin":"xi«éoxƒ´n","Nghƒ©a ti·∫øng Vi·ªát":"c·∫©n th·∫≠n"},{"ÁπÅÈ´î":"Êñ∞ÈÆÆ","Pinyin":"xƒ´nxiƒÅn","Nghƒ©a ti·∫øng Vi·ªát":"t∆∞∆°i, m·ªõi (th∆∞·ªùng d√πng cho ƒë·ªì ƒÉn)"},{"ÁπÅÈ´î":"Ëµ∑Â∫ä","Pinyin":"q«êchu√°ng","Nghƒ©a ti·∫øng Vi·ªát":"th·ª©c d·∫≠y"},{"ÁπÅÈ´î":"È§Ö‰πæ","Pinyin":"b«ênggƒÅn","Nghƒ©a ti·∫øng Vi·ªát":"b√°nh quy"},{"ÁπÅÈ´î":"ËÄå‰∏î","Pinyin":"√©rqiƒõ","Nghƒ©a ti·∫øng Vi·ªát":"h∆°n n·ªØa, m√† c√≤n"},{"ÁπÅÈ´î":"ÈõñÁÑ∂","Pinyin":"suƒ´r√°n","Nghƒ©a ti·∫øng Vi·ªát":"m·∫∑c d√π"},{"ÁπÅÈ´î":"Áõ∏‰ø°","Pinyin":"xiƒÅngx√¨n","Nghƒ©a ti·∫øng Vi·ªát":"tin t∆∞·ªüng"},{"ÁπÅÈ´î":"ÊñºÊòØ","Pinyin":"y√∫sh√¨","Nghƒ©a ti·∫øng Vi·ªát":"th·∫ø l√†, v·∫≠y n√™n"},{"ÁπÅÈ´î":"‰øùË≠∑","Pinyin":"b«éoh√π","Nghƒ©a ti·∫øng Vi·ªát":"b·∫£o v·ªá"},{"ÁπÅÈ´î":"‰ΩúËÄÖ","Pinyin":"zu√≤zhƒõ","Nghƒ©a ti·∫øng Vi·ªát":"t√°c gi·∫£"},{"ÁπÅÈ´î":"ËÅäÂ§©","Pinyin":"li√°otiƒÅn","Nghƒ©a ti·∫øng Vi·ªát":"n√≥i chuy·ªán, t√°n g·∫´u"},{"ÁπÅÈ´î":"Ê≥®ÊÑè","Pinyin":"zh√πy√¨","Nghƒ©a ti·∫øng Vi·ªát":"ch√∫ √Ω"},{"ÁπÅÈ´î":"Ê†°Èï∑","Pinyin":"xi√†ozh«éng","Nghƒ©a ti·∫øng Vi·ªát":"hi·ªáu tr∆∞·ªüng"},{"ÁπÅÈ´î":"ÈÇÄË´ã","Pinyin":"yƒÅoq«êng","Nghƒ©a ti·∫øng Vi·ªát":"m·ªùi"},{"ÁπÅÈ´î":"Ë¨õÂÆå","Pinyin":"ji«éng w√°n","Nghƒ©a ti·∫øng Vi·ªát":"n√≥i xong"},{"ÁπÅÈ´î":"Êé•Ëëó","Pinyin":"jiƒìzhe","Nghƒ©a ti·∫øng Vi·ªát":"ti·∫øp theo"},{"ÁπÅÈ´î":"ÂØ¶Èöõ","Pinyin":"sh√≠j√¨","Nghƒ©a ti·∫øng Vi·ªát":"th·ª±c t·∫ø"},{"ÁπÅÈ´î":"ÂÖ¨Âëä","Pinyin":"g≈çngg√†o","Nghƒ©a ti·∫øng Vi·ªát":"th√¥ng b√°o"},{"ÁπÅÈ´î":"Âä™Âäõ","Pinyin":"n«îl√¨","Nghƒ©a ti·∫øng Vi·ªát":"n·ªó l·ª±c, c·ªë g·∫Øng"},{"ÁπÅÈ´î":"‰∫ãÊÉÖ","Pinyin":"sh√¨q√≠ng","Nghƒ©a ti·∫øng Vi·ªát":"s·ª± vi·ªác, chuy·ªán"}];
    
    // Global state
    let currentTheme = localStorage.getItem('theme') || 'light';
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let studiedWords = JSON.parse(localStorage.getItem('studiedWords') || '[]');
    let quizStats = JSON.parse(localStorage.getItem('quizStats') || '{"correct": 0, "total": 0}');
    let currentFlashcard = 0;
    let currentQuiz = null;
    let speechInitialized = false;
    let isPlayingAudio = false;
    let usedQuizWords = new Set(); // Track words already used in current quiz session
    
    // Study Streak & Daily Goals System
    let studyStreak = JSON.parse(localStorage.getItem('studyStreak') || '{"current": 0, "best": 0, "lastStudyDate": null}');
    let dailyGoal = JSON.parse(localStorage.getItem('dailyGoal') || '{"target": 15, "completed": 0, "date": null}');
    let studySession = JSON.parse(localStorage.getItem('studySession') || '{"wordsToday": 0, "timeToday": 0, "startTime": null}');
    
    // SRS System Data
    let srsEnabled = JSON.parse(localStorage.getItem('srsEnabled') || 'true');
    if (!DATA[0].srs) {
      initializeSRSData();
    }
    
    // DOM elements
    const q = document.getElementById('q');
    const tbody = document.querySelector('#tbl tbody');
    
    // Initialize app
    function init() {
      applyTheme(currentTheme);
      updateStats();
      render();
      setupEventListeners();
      showMobileTip();
    }
    
    // Show mobile audio tip
    function showMobileTip() {
      // Check if user is on mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const tipElement = document.getElementById('audioTip');
      
      if (isMobile && tipElement) {
        // Show tip after a delay
        setTimeout(() => {
          tipElement.style.display = 'block';
          tipElement.style.animation = 'fadeIn 0.5s ease-out';
          
          // Hide tip after 5 seconds
          setTimeout(() => {
            tipElement.style.opacity = '0';
            tipElement.style.transition = 'opacity 0.5s ease-out';
            setTimeout(() => {
              tipElement.style.display = 'none';
            }, 500);
          }, 5000);
        }, 2000);
      }
    }

    // ===== STUDY STREAK & DAILY GOALS SYSTEM =====
    function updateStudyStreak() {
      const today = new Date().toDateString();
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      
      if (studyStreak.lastStudyDate !== today) {
        if (studyStreak.lastStudyDate === yesterday) {
          // Continue streak
          studyStreak.current++;
          showToast(`üî• Streak ${studyStreak.current} ng√†y! Tuy·ªát v·ªùi!`, 'success');
        } else if (studyStreak.lastStudyDate === null) {
          // First day
          studyStreak.current = 1;
          showToast('üéØ B·∫Øt ƒë·∫ßu streak h·ªçc t·∫≠p!', 'info');
        } else {
          // Streak broken
          if (studyStreak.current > 0) {
            showToast(`üíî Streak b·ªã gi√°n ƒëo·∫°n. H√£y b·∫Øt ƒë·∫ßu l·∫°i!`, 'warning');
          }
          studyStreak.current = 1;
        }
        
        studyStreak.lastStudyDate = today;
        if (studyStreak.current > studyStreak.best) {
          studyStreak.best = studyStreak.current;
          showToast(`üèÜ K·ª∑ l·ª•c m·ªõi: ${studyStreak.best} ng√†y!`, 'success');
        }
        
        localStorage.setItem('studyStreak', JSON.stringify(studyStreak));
        updateStats();
      }
    }

    function updateDailyGoal() {
      const today = new Date().toDateString();
      
      if (dailyGoal.date !== today) {
        dailyGoal.completed = 0;
        dailyGoal.date = today;
      }
      
      dailyGoal.completed++;
      localStorage.setItem('dailyGoal', JSON.stringify(dailyGoal));
      
      if (dailyGoal.completed >= dailyGoal.target) {
        showToast(`üéâ Ho√†n th√†nh m·ª•c ti√™u h√¥m nay! (${dailyGoal.completed}/${dailyGoal.target})`, 'success');
        updateStudyStreak();
      } else {
        const remaining = dailyGoal.target - dailyGoal.completed;
        showToast(`‚ú® Ti·∫øn b·ªô tuy·ªát v·ªùi! C√≤n ${remaining} t·ª´ n·ªØa ƒë·ªÉ ƒë·∫°t m·ª•c ti√™u`, 'info');
      }
      
      updateStats();
    }

    function updateStudySession() {
      const today = new Date().toDateString();
      
      if (studySession.date !== today) {
        studySession.wordsToday = 0;
        studySession.timeToday = 0;
        studySession.date = today;
        studySession.startTime = Date.now();
      }
      
      studySession.wordsToday++;
      studySession.timeToday = Math.floor((Date.now() - studySession.startTime) / 1000 / 60); // minutes
      
      localStorage.setItem('studySession', JSON.stringify(studySession));
    }

    // ===== SRS SYSTEM =====
    function initializeSRSData() {
      DATA.forEach(word => {
        if (!word.srs) {
          word.srs = {
            level: 0,           // 0-5
            nextReview: new Date(),
            lastReviewed: null,
            correctCount: 0,
            wrongCount: 0,
            ease: 2.5,          // 1.3-3.0
            interval: 1         // days
          };
        }
      });
      localStorage.setItem('vocabularyData', JSON.stringify(DATA));
    }

    function updateSRS(word, correct, responseTime = 3) {
      if (!srsEnabled) return;
      
      const srs = word.srs;
      srs.lastReviewed = new Date();
      
      if (correct) {
        srs.correctCount++;
        
        // Update ease factor
        srs.ease = Math.max(1.3, srs.ease + (0.1 - (3 - responseTime) * (0.08 + (3 - responseTime) * 0.02)));
        
        // Update level and interval
        if (srs.level === 0) {
          srs.level = 1;
          srs.interval = 1;
        } else if (srs.level === 1) {
          srs.level = 2;
          srs.interval = 6;
        } else {
          srs.level = Math.min(5, srs.level + 1);
          srs.interval = Math.round(srs.interval * srs.ease);
        }
      } else {
        srs.wrongCount++;
        srs.level = Math.max(0, srs.level - 1);
        srs.interval = Math.max(1, Math.round(srs.interval * 0.8));
        srs.ease = Math.max(1.3, srs.ease - 0.2);
      }
      
      // Calculate next review date
      srs.nextReview = new Date(Date.now() + srs.interval * 24 * 60 * 60 * 1000);
      
      localStorage.setItem('vocabularyData', JSON.stringify(DATA));
    }

    function getDueWords() {
      const now = new Date();
      return DATA.filter(word => word.srs && new Date(word.srs.nextReview) <= now);
    }

    function getNewWords() {
      return DATA.filter(word => word.srs && word.srs.level === 0);
    }

    // ===== TOAST NOTIFICATION SYSTEM =====
    function showToast(message, type = 'info', duration = 3000) {
      const toastContainer = document.getElementById('toastContainer') || createToastContainer();
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-content">
          <span class="toast-icon">${getToastIcon(type)}</span>
          <span class="toast-message">${message}</span>
          <button class="toast-close" onclick="closeToast(this)">&times;</button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Animate in
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Auto remove
      setTimeout(() => {
        closeToast(toast.querySelector('.toast-close'));
      }, duration);
    }

    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container';
      document.body.appendChild(container);
      return container;
    }

    function getToastIcon(type) {
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      return icons[type] || icons.info;
    }

    function closeToast(closeBtn) {
      const toast = closeBtn.closest('.toast');
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }

    // ===== WRITING PRACTICE SYSTEM =====
    let writingCanvas, writingCtx;
    let isDrawing = false;
    let currentWritingWord = 0;

    function openWritingPractice() {
      document.getElementById('writingModal').style.display = 'flex';
      initWritingCanvas();
      setWritingWord();
    }

    function initWritingCanvas() {
      writingCanvas = document.getElementById('writingCanvas');
      writingCtx = writingCanvas.getContext('2d');
      
      // Set up canvas for drawing
      writingCtx.strokeStyle = '#3b82f6';
      writingCtx.lineWidth = 3;
      writingCtx.lineCap = 'round';
      writingCtx.lineJoin = 'round';
      
      // Add drawing event listeners
      writingCanvas.addEventListener('mousedown', startDrawing);
      writingCanvas.addEventListener('mousemove', draw);
      writingCanvas.addEventListener('mouseup', stopDrawing);
      writingCanvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events for mobile
      writingCanvas.addEventListener('touchstart', handleTouch);
      writingCanvas.addEventListener('touchmove', handleTouch);
      writingCanvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e) {
      isDrawing = true;
      const rect = writingCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      writingCtx.beginPath();
      writingCtx.moveTo(x, y);
    }

    function draw(e) {
      if (!isDrawing) return;
      const rect = writingCanvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      writingCtx.lineTo(x, y);
      writingCtx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function handleTouch(e) {
      e.preventDefault();
      const rect = writingCanvas.getBoundingClientRect();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                       e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      writingCanvas.dispatchEvent(mouseEvent);
    }

    function clearCanvas() {
      writingCtx.clearRect(0, 0, writingCanvas.width, writingCanvas.height);
      showToast('Canvas ƒë√£ ƒë∆∞·ª£c x√≥a', 'info', 1500);
    }

    function setWritingWord() {
      const word = DATA[currentWritingWord];
      document.getElementById('targetCharacter').textContent = word["ÁπÅÈ´î"];
      clearCanvas();
    }

    function nextWritingCharacter() {
      currentWritingWord = (currentWritingWord + 1) % DATA.length;
      setWritingWord();
      updateDailyGoal();
      updateStudySession();
      showToast('T·ª´ ti·∫øp theo!', 'success', 1500);
    }

    function showStrokeOrder() {
      const word = DATA[currentWritingWord];
      showToast(`Stroke order cho "${word["ÁπÅÈ´î"]}" - T√≠nh nƒÉng s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t`, 'info');
    }

    // ===== SRS REVIEW SYSTEM =====
    let currentSRSWords = [];
    let currentSRSIndex = 0;

    function openSRSReview() {
      currentSRSWords = getDueWords();
      
      if (currentSRSWords.length === 0) {
        showToast('üéâ Tuy·ªát v·ªùi! Kh√¥ng c√≥ t·ª´ n√†o c·∫ßn √¥n t·∫≠p h√¥m nay', 'success');
        return;
      }
      
      currentSRSIndex = 0;
      document.getElementById('srsModal').style.display = 'flex';
      showSRSWord();
    }

    function showSRSWord() {
      if (currentSRSIndex >= currentSRSWords.length) {
        showSRSCompletion();
        return;
      }
      
      const word = currentSRSWords[currentSRSIndex];
      document.getElementById('srsChinese').textContent = word["ÁπÅÈ´î"];
      document.getElementById('srsPinyin').textContent = word["Pinyin"];
      document.getElementById('srsVietnamese').textContent = word["Nghƒ©a ti·∫øng Vi·ªát"];
      document.getElementById('srsRemaining').textContent = currentSRSWords.length - currentSRSIndex;
      
      // Reset visibility
      document.getElementById('srsPinyin').style.display = 'none';
      document.getElementById('srsVietnamese').style.display = 'none';
      document.getElementById('srsRevealBtn').style.display = 'inline-flex';
      document.getElementById('srsRating').style.display = 'none';
    }

    function revealSRSAnswer() {
      document.getElementById('srsPinyin').style.display = 'block';
      document.getElementById('srsVietnamese').style.display = 'block';
      document.getElementById('srsRevealBtn').style.display = 'none';
      document.getElementById('srsRating').style.display = 'block';
    }

    function rateSRS(difficulty) {
      const word = currentSRSWords[currentSRSIndex];
      const correct = difficulty >= 3;
      
      updateSRS(word, correct, difficulty);
      updateDailyGoal();
      updateStudySession();
      
      if (correct) {
        markAsStudied(word);
        showToast(`‚úÖ T·ªët l·∫Øm! T·ª´ n√†y s·∫Ω xu·∫•t hi·ªán l·∫°i sau ${word.srs.interval} ng√†y`, 'success', 2000);
      } else {
        showToast('üí™ Kh√¥ng sao! H√£y c·ªë g·∫Øng l·∫ßn sau', 'warning', 2000);
      }
      
      currentSRSIndex++;
      setTimeout(() => showSRSWord(), 1000);
    }

    function showSRSCompletion() {
      document.getElementById('srsContent').innerHTML = `
        <div style="text-align:center;padding:3rem">
          <div style="font-size:4rem;margin-bottom:1rem">üéâ</div>
          <h3>Ho√†n th√†nh √¥n t·∫≠p!</h3>
          <p style="color:var(--fg-secondary);margin-bottom:2rem">
            B·∫°n ƒë√£ √¥n t·∫≠p xong ${currentSRSWords.length} t·ª´ v·ª±ng h√¥m nay
          </p>
          <button onclick="closeModal('srsModal')" class="btn-primary">
            Tuy·ªát v·ªùi!
          </button>
        </div>
      `;
    }

    // ===== QUICK ACTIONS =====
    function showQuickActions() {
      const actions = [
        { icon: 'üóÇÔ∏è', text: 'Flashcard', action: 'openFlashcards()' },
        { icon: 'üß†', text: 'Quiz', action: 'openQuiz()' },
        { icon: '‚úçÔ∏è', text: 'Luy·ªán vi·∫øt', action: 'openWritingPractice()' },
        { icon: 'üìÖ', text: 'SRS Review', action: 'openSRSReview()' },
        { icon: 'üé≤', text: 'T·ª´ ng·∫´u nhi√™n', action: 'getRandomWord()' }
      ];
      
      let actionsHTML = actions.map(action => 
        `<div onclick="${action.action}" style="padding:1rem;border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.3s ease;margin-bottom:0.5rem" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='var(--bg)'">
          <span style="margin-right:0.5rem">${action.icon}</span>
          ${action.text}
        </div>`
      ).join('');
      
      showToast(`
        <div style="min-width:200px">
          <strong style="display:block;margin-bottom:1rem">‚ö° Quick Actions</strong>
          ${actionsHTML}
        </div>
      `, 'info', 8000);
    }
    
    // Theme management
    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      applyTheme(currentTheme);
      localStorage.setItem('theme', currentTheme);
    }
    
    function applyTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      const themeIcon = document.getElementById('themeIcon');
      const themeText = document.getElementById('themeText');
      if (theme === 'dark') {
        themeIcon.textContent = '‚òÄÔ∏è';
        themeText.textContent = 'Ch·∫ø ƒë·ªô s√°ng';
      } else {
        themeIcon.textContent = 'üåô';
        themeText.textContent = 'Ch·∫ø ƒë·ªô t·ªëi';
      }
    }
    
    // Enhanced Statistics
    function updateStats() {
      document.getElementById('totalWords').textContent = DATA.length;
      document.getElementById('studiedWords').textContent = studiedWords.length;
      document.getElementById('favoriteWords').textContent = favorites.length;
      const accuracy = quizStats.total > 0 ? Math.round((quizStats.correct / quizStats.total) * 100) : 0;
      document.getElementById('accuracy').textContent = accuracy + '%';
      
      // Update streak and daily goal
      document.getElementById('currentStreak').textContent = studyStreak.current || 0;
      document.getElementById('dailyProgress').textContent = `${dailyGoal.completed || 0}/${dailyGoal.target}`;
      
      // Update due words count
      const dueWords = getDueWords();
      const dueElement = document.getElementById('dueWordsCount');
      if (dueElement) {
        dueElement.textContent = `${dueWords.length} t·ª´ c·∫ßn √¥n`;
      }
    }
    
    // Utility functions
    function strip(s) {
      return (s || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    
    function isFavorite(word) {
      return favorites.some(fav => fav['ÁπÅÈ´î'] === word['ÁπÅÈ´î']);
    }
    
    function toggleFavorite(word) {
      const index = favorites.findIndex(fav => fav['ÁπÅÈ´î'] === word['ÁπÅÈ´î']);
      if (index > -1) {
        favorites.splice(index, 1);
      } else {
        favorites.push(word);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateStats();
      render();
    }
    
    function markAsStudied(word) {
      if (!studiedWords.some(studied => studied['ÁπÅÈ´î'] === word['ÁπÅÈ´î'])) {
        studiedWords.push(word);
        localStorage.setItem('studiedWords', JSON.stringify(studiedWords));
        updateDailyGoal();
        updateStudySession();
        updateStats();
      }
    }
    
    // Render table
    function render() {
      const term = strip(q.value.trim());
      const rows = DATA.filter(r => !term || strip([r["ÁπÅÈ´î"], r["Pinyin"], r["Nghƒ©a ti·∫øng Vi·ªát"]].join(' ')).includes(term));
      
      tbody.innerHTML = rows.map((r, i) => `
        <tr>
          <td class="idx">${i + 1}</td>
          <td class="chinese">${r["ÁπÅÈ´î"]}</td>
          <td class="pinyin">${r["Pinyin"]}</td>
          <td class="vietnamese">${r["Nghƒ©a ti·∫øng Vi·ªát"]}</td>
          <td>
            <button onclick="toggleFavorite(DATA[${DATA.indexOf(r)}])" style="background:${isFavorite(r) ? 'var(--danger)' : 'var(--bg)'};color:${isFavorite(r) ? 'white' : 'var(--fg)'};border-color:${isFavorite(r) ? 'var(--danger)' : 'var(--border)'};padding:0.5rem;margin-right:0.5rem">
              ${isFavorite(r) ? '‚ù§Ô∏è' : 'ü§ç'}
            </button>
            <button onclick="speakChinese('${r["ÁπÅÈ´î"]}')" style="background:var(--success);color:white;border-color:var(--success);padding:0.5rem" title="Ph√°t √¢m">
              üîä
            </button>
          </td>
        </tr>
      `).join('');
    }
    
    // Initialize speech synthesis for mobile compatibility
    function initializeSpeech() {
      if (!speechInitialized && 'speechSynthesis' in window) {
        try {
          // Create a dummy utterance to initialize speech synthesis on mobile
          const testUtterance = new SpeechSynthesisUtterance('');
          testUtterance.volume = 0;
          speechSynthesis.speak(testUtterance);
          speechInitialized = true;
          console.log('Speech synthesis initialized for mobile');
        } catch (error) {
          console.warn('Failed to initialize speech synthesis:', error);
        }
      }
    }

    // Audio pronunciation with enhanced mobile support
    function speakChinese(text = null) {
      // Initialize speech if not done yet
      if (!speechInitialized) {
        initializeSpeech();
      }

      if (!text) {
        const flashcardChinese = document.getElementById('flashcardChinese');
        text = flashcardChinese ? flashcardChinese.textContent : '';
      }
      
      if (!text) {
        console.warn('No text to speak');
        return;
      }

      if (!('speechSynthesis' in window)) {
        alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t √¢m t·ª± ƒë·ªông. Vui l√≤ng s·ª≠ d·ª•ng tr√¨nh duy·ªát kh√°c ho·∫∑c c·∫≠p nh·∫≠t l√™n phi√™n b·∫£n m·ªõi nh·∫•t.');
        return;
      }

      // Stop any currently playing speech
      if (isPlayingAudio) {
        speechSynthesis.cancel();
        isPlayingAudio = false;
        updateAudioButtons(false);
        return;
      }

      try {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.8;
        utterance.volume = 1.0;
        utterance.pitch = 1.0;

        // Add event listeners for better feedback
        utterance.onstart = function() {
          isPlayingAudio = true;
          updateAudioButtons(true);
          console.log('Started speaking:', text);
        };

        utterance.onend = function() {
          isPlayingAudio = false;
          updateAudioButtons(false);
          console.log('Finished speaking:', text);
        };

        utterance.onerror = function(event) {
          isPlayingAudio = false;
          updateAudioButtons(false);
          console.error('Speech synthesis error:', event.error);
          
          // Try fallback TTS before showing error
          console.log('Attempting fallback TTS...');
          const fallbackAudio = fallbackTTS(text);
          
          if (!fallbackAudio) {
            // Show user-friendly error message only if fallback also fails
            if (event.error === 'network') {
              alert('L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.');
            } else if (event.error === 'not-allowed') {
              alert('Vui l√≤ng cho ph√©p tr√¨nh duy·ªát ph√°t √¢m thanh. Ki·ªÉm tra c√†i ƒë·∫∑t quy·ªÅn c·ªßa tr√¨nh duy·ªát.');
            } else {
              alert('Kh√¥ng th·ªÉ ph√°t √¢m thanh. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c s·ª≠ d·ª•ng tr√¨nh duy·ªát kh√°c.');
            }
          }
        };

        // For mobile Safari compatibility
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          // Delay slightly for iOS
          setTimeout(() => {
            speechSynthesis.speak(utterance);
          }, 100);
        } else {
          speechSynthesis.speak(utterance);
        }

      } catch (error) {
        console.error('Error creating speech utterance:', error);
        alert('L·ªói khi t·∫°o √¢m thanh. Vui l√≤ng th·ª≠ l·∫°i.');
        isPlayingAudio = false;
        updateAudioButtons(false);
      }
    }

    // Update audio button appearance
    function updateAudioButtons(isPlaying) {
      const audioButtons = document.querySelectorAll('button[onclick*="speakChinese"]');
      audioButtons.forEach(button => {
        if (isPlaying) {
          button.innerHTML = '‚èπÔ∏è';
          button.title = 'D·ª´ng ph√°t √¢m';
          button.style.background = 'var(--warning)';
          button.style.animation = 'pulse 1s infinite';
        } else {
          button.innerHTML = 'üîä';
          button.title = 'Ph√°t √¢m';
          button.style.background = 'var(--success)';
          button.style.animation = 'none';
        }
      });
    }

    // Fallback TTS using Google Translate (for when Web Speech API fails)
    function fallbackTTS(text) {
      if (!text) return;
      
      try {
        // Create an audio element with Google Translate TTS
        const audio = new Audio();
        const encodedText = encodeURIComponent(text);
        audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=zh-cn&client=tw-ob`;
        audio.crossOrigin = 'anonymous';
        
        audio.onloadstart = function() {
          isPlayingAudio = true;
          updateAudioButtons(true);
          console.log('Fallback TTS started for:', text);
        };
        
        audio.onended = function() {
          isPlayingAudio = false;
          updateAudioButtons(false);
          console.log('Fallback TTS ended for:', text);
        };
        
        audio.onerror = function(error) {
          isPlayingAudio = false;
          updateAudioButtons(false);
          console.error('Fallback TTS error:', error);
          alert('Kh√¥ng th·ªÉ ph√°t √¢m thanh. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.');
        };
        
        audio.play().catch(error => {
          console.error('Failed to play fallback audio:', error);
          isPlayingAudio = false;
          updateAudioButtons(false);
          alert('Kh√¥ng th·ªÉ ph√°t √¢m thanh. Tr√¨nh duy·ªát c√≥ th·ªÉ ƒë√£ ch·∫∑n t·ª± ƒë·ªông ph√°t audio.');
        });
        
        return audio;
      } catch (error) {
        console.error('Error creating fallback TTS:', error);
        alert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o √¢m thanh d·ª± ph√≤ng.');
        return null;
      }
    }
    
    // Export CSV
    function exportCSV() {
      const header = ["#", "ÁπÅÈ´î", "Pinyin", "Nghƒ©a ti·∫øng Vi·ªát"];
      const term = strip(q.value.trim());
      const rows = DATA.filter(r => !term || strip([r["ÁπÅÈ´î"], r["Pinyin"], r["Nghƒ©a ti·∫øng Vi·ªát"]].join(' ')).includes(term));
      const lines = [header.join(',')].concat(rows.map((r, i) => [i + 1, r["ÁπÅÈ´î"], r["Pinyin"], `"${r["Nghƒ©a ti·∫øng Vi·ªát"].replace(/"/g, '""')}"`].join(',')));
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vocab-30.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // Random word
    function getRandomWord() {
      const randomWord = DATA[Math.floor(Math.random() * DATA.length)];
      q.value = randomWord["ÁπÅÈ´î"];
      render();
      q.focus();
    }
    
    // Modal management
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Flashcard functionality
    function openFlashcards() {
      currentFlashcard = 0;
      showFlashcard();
      document.getElementById('flashcardModal').style.display = 'flex';
    }
    
    function showFlashcard() {
      if (currentFlashcard >= DATA.length) currentFlashcard = 0;
      
      const word = DATA[currentFlashcard];
      document.getElementById('flashcardChinese').textContent = word["ÁπÅÈ´î"];
      document.getElementById('flashcardPinyin').textContent = word["Pinyin"];
      document.getElementById('flashcardVietnamese').textContent = word["Nghƒ©a ti·∫øng Vi·ªát"];
      
      // Reset visibility
      document.getElementById('flashcardPinyin').style.display = 'none';
      document.getElementById('flashcardVietnamese').style.display = 'none';
      document.getElementById('revealBtn').style.display = 'inline-flex';
      document.getElementById('nextCardBtn').style.display = 'none';
    }
    
    function revealAnswer() {
      document.getElementById('flashcardPinyin').style.display = 'block';
      document.getElementById('flashcardVietnamese').style.display = 'block';
      document.getElementById('revealBtn').style.display = 'none';
      document.getElementById('nextCardBtn').style.display = 'inline-flex';
      
      markAsStudied(DATA[currentFlashcard]);
    }
    
    function nextFlashcard() {
      currentFlashcard = (currentFlashcard + 1) % DATA.length;
      showFlashcard();
    }
    
    // Quiz functionality
    function openQuiz() {
      updateQuizProgress(); // Initialize progress display
      startNewQuiz();
      document.getElementById('quizModal').style.display = 'flex';
    }
    
    function startNewQuiz() {
      // Get available words (not used yet)
      const availableWords = DATA.filter(word => !usedQuizWords.has(word["ÁπÅÈ´î"]));
      
      // If all words have been used, reset and start over
      if (availableWords.length === 0) {
        usedQuizWords.clear();
        showQuizCompletionMessage();
        return;
      }
      
      // Select random word from available words
      const randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
      usedQuizWords.add(randomWord["ÁπÅÈ´î"]);
      
      // Get other words for wrong options (excluding the correct one)
      const otherWords = DATA.filter(w => w !== randomWord);
      const wrongOptions = [];
      
      while (wrongOptions.length < 3 && otherWords.length > 0) {
        const randomIndex = Math.floor(Math.random() * otherWords.length);
        wrongOptions.push(otherWords.splice(randomIndex, 1)[0]);
      }
      
      const allOptions = [randomWord, ...wrongOptions].sort(() => Math.random() - 0.5);
      
      currentQuiz = {
        correct: randomWord,
        options: allOptions,
        answered: false
      };
      
      document.getElementById('quizChinese').textContent = randomWord["ÁπÅÈ´î"];
      document.getElementById('quizPinyin').textContent = randomWord["Pinyin"];
      
      const optionsContainer = document.getElementById('quizOptions');
      optionsContainer.innerHTML = allOptions.map((option, i) => `
        <button onclick="selectQuizOption(${i})" style="padding:1rem;border:2px solid var(--border);border-radius:8px;background:var(--bg);color:var(--fg);cursor:pointer;transition:all 0.3s ease" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
          ${option["Nghƒ©a ti·∫øng Vi·ªát"]}
        </button>
      `).join('');
      
      // Update quiz progress display
      updateQuizProgress();
      
      document.getElementById('quizResult').style.display = 'none';
      document.getElementById('nextQuestionBtn').style.display = 'none';
    }

    function showQuizCompletionMessage() {
      const resultDiv = document.getElementById('quizResult');
      resultDiv.innerHTML = `
        <div style="padding:1.5rem;border-radius:8px;background:var(--success);color:white;margin-top:1rem;text-align:center">
          <strong>üéâ Ch√∫c m·ª´ng!</strong><br>
          B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ ${DATA.length} t·ª´ v·ª±ng!<br>
          <button onclick="resetQuiz()" style="margin-top:1rem;background:white;color:var(--success);border:2px solid white;border-radius:6px;padding:0.5rem 1rem;font-weight:600;cursor:pointer">
            üîÑ B·∫Øt ƒë·∫ßu l·∫°i
          </button>
        </div>
      `;
      resultDiv.style.display = 'block';
      document.getElementById('nextQuestionBtn').style.display = 'none';
    }

    function updateQuizProgress() {
      const progress = usedQuizWords.size;
      const total = DATA.length;
      const progressElement = document.getElementById('quizProgress');
      if (progressElement) {
        progressElement.textContent = `${progress}/${total}`;
      }
    }

    function resetQuiz() {
      if (usedQuizWords.size > 0) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën b·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu? Ti·∫øn ƒë·ªô hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.')) {
          return;
        }
      }
      usedQuizWords.clear();
      startNewQuiz();
      
      // Show brief notification
      const resultDiv = document.getElementById('quizResult');
      resultDiv.innerHTML = `
        <div style="padding:1rem;border-radius:8px;background:var(--primary);color:white;margin-top:1rem;text-align:center">
          üîÑ ƒê√£ kh·ªüi t·∫°o l·∫°i quiz v·ªõi t·∫•t c·∫£ ${DATA.length} t·ª´ v·ª±ng
        </div>
      `;
      resultDiv.style.display = 'block';
      
      // Hide notification after 2 seconds
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 2000);
    }
    
    function selectQuizOption(optionIndex) {
      if (currentQuiz.answered) return;
      
      currentQuiz.answered = true;
      const selectedOption = currentQuiz.options[optionIndex];
      const isCorrect = selectedOption === currentQuiz.correct;
      
      // Update quiz stats
      quizStats.total++;
      if (isCorrect) quizStats.correct++;
      localStorage.setItem('quizStats', JSON.stringify(quizStats));
      
      // Update SRS for this word
      updateSRS(currentQuiz.correct, isCorrect);
      
      // Show result
      const resultDiv = document.getElementById('quizResult');
      resultDiv.innerHTML = `
        <div style="padding:1rem;border-radius:8px;background:${isCorrect ? 'var(--success)' : 'var(--danger)'};color:white;margin-top:1rem">
          <strong>${isCorrect ? '‚úÖ Ch√≠nh x√°c!' : '‚ùå Sai r·ªìi!'}</strong><br>
          ƒê√°p √°n ƒë√∫ng: ${currentQuiz.correct["Nghƒ©a ti·∫øng Vi·ªát"]}<br>
          <small>SRS: T·ª´ n√†y s·∫Ω xu·∫•t hi·ªán l·∫°i sau ${currentQuiz.correct.srs.interval} ng√†y</small>
        </div>
      `;
      resultDiv.style.display = 'block';
      document.getElementById('nextQuestionBtn').style.display = 'inline-flex';
      
      if (isCorrect) {
        markAsStudied(currentQuiz.correct);
        showToast('üéâ Tuy·ªát v·ªùi! +1 ƒëi·ªÉm', 'success', 1500);
      } else {
        showToast('üí™ ƒê·ª´ng b·ªè cu·ªôc! H√£y th·ª≠ l·∫°i', 'warning', 1500);
      }
      
      updateStats();
    }
    
    function nextQuestion() {
      startNewQuiz();
    }
    
    // Event listeners
    function setupEventListeners() {
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      document.getElementById('export').addEventListener('click', exportCSV);
      document.getElementById('clear').addEventListener('click', () => { q.value = ''; render(); });
      document.getElementById('randomBtn').addEventListener('click', getRandomWord);
      q.addEventListener('input', render);
      
      // Flashcard events
      document.getElementById('revealBtn').addEventListener('click', revealAnswer);
      document.getElementById('nextCardBtn').addEventListener('click', nextFlashcard);
      document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);
      
      // SRS events
      document.getElementById('srsRevealBtn').addEventListener('click', revealSRSAnswer);
      
      // Initialize speech synthesis on first user interaction (for mobile compatibility)
      const firstInteractionEvents = ['click', 'touchstart', 'keydown'];
      const initSpeechOnce = () => {
        initializeSpeech();
        firstInteractionEvents.forEach(event => {
          document.removeEventListener(event, initSpeechOnce, true);
        });
      };
      
      firstInteractionEvents.forEach(event => {
        document.addEventListener(event, initSpeechOnce, true);
      });
      
      // Close modals when clicking outside
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
