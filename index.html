<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tá»« vá»±ng 30 má»¥c â€” file Ä‘Æ¡n</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box}
    :root{
      --primary:#3b82f6;--primary-dark:#1d4ed8;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --bg:#ffffff;--bg-secondary:#f8fafc;--bg-tertiary:#f1f5f9;
      --fg:#0f172a;--fg-secondary:#475569;--fg-muted:#64748b;
      --border:#e2e8f0;--border-hover:#cbd5e1;
      --shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --gradient:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    [data-theme="dark"]{
      --bg:#0f172a;--bg-secondary:#1e293b;--bg-tertiary:#334155;
      --fg:#f8fafc;--fg-secondary:#cbd5e1;--fg-muted:#94a3b8;
      --border:#334155;--border-hover:#475569;
      --shadow:0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
      --shadow-lg:0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
    }
    body{margin:0;background:var(--bg);color:var(--fg);font-family:"Noto Sans","Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Arial;transition:all 0.3s ease;line-height:1.6}
    
    /* Header */
    header{background:var(--gradient);color:white;padding:2rem 1rem;text-align:center;position:relative;overflow:hidden}
    header::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="3" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');opacity:0.3}
    h1{margin:0 0 0.5rem 0;font-size:clamp(1.8rem,4vw,2.5rem);font-weight:700;position:relative;z-index:1}
    .sub{margin:0;opacity:0.9;font-size:1.1rem;position:relative;z-index:1}
    
    /* Navigation */
    .nav{background:var(--bg);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;backdrop-filter:blur(10px);box-shadow:var(--shadow)}
    .nav-content{max-width:1200px;margin:0 auto;padding:1rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    
    /* Theme Toggle */
    .theme-toggle{background:var(--bg-secondary);border:1px solid var(--border);border-radius:50px;padding:0.5rem;cursor:pointer;display:flex;align-items:center;gap:0.5rem;transition:all 0.3s ease;min-width:auto}
    .theme-toggle:hover{background:var(--bg-tertiary);border-color:var(--border-hover)}
    
    /* Controls */
    .controls{background:var(--bg-secondary);margin:1rem;border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    input[type=search]{flex:1;min-width:280px;padding:0.75rem 1rem;border:2px solid var(--border);border-radius:10px;background:var(--bg);color:var(--fg);font-size:1rem;transition:all 0.3s ease}
    input[type=search]:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgb(59 130 246 / 0.1)}
    
    /* Buttons */
    button{border:2px solid var(--border);background:var(--bg);color:var(--fg);border-radius:10px;padding:0.75rem 1.5rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:0.5rem;font-size:0.95rem}
    button:hover{border-color:var(--primary);color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow)}
    button:active{transform:translateY(0)}
    .btn-primary{background:var(--primary);color:white;border-color:var(--primary)}
    .btn-primary:hover{background:var(--primary-dark);border-color:var(--primary-dark);color:white}
    
    /* Main Content */
    main{max-width:1200px;margin:0 auto;padding:1rem}
    .card{background:var(--bg);border-radius:12px;box-shadow:var(--shadow);margin-bottom:2rem}
    .table-container{overflow:auto;border-radius:12px}
    
    /* Table */
    table{width:100%;border-collapse:collapse}
    thead{background:var(--bg-secondary)}
    thead th{padding:1rem;text-align:left;font-weight:600;color:var(--fg-secondary);border-bottom:2px solid var(--border);position:sticky;top:0;z-index:10;background:var(--bg-secondary)}
    tbody td{padding:1rem;border-bottom:1px solid var(--border);vertical-align:top;transition:all 0.2s ease}
    tbody tr:hover{background:var(--bg-secondary);transform:scale(1.01)}
    .idx{width:60px;color:var(--fg-muted);font-weight:600}
    .chinese{font-size:1.4rem;font-weight:600;color:var(--primary)}
    .pinyin{font-style:italic;color:var(--fg-secondary);font-size:1.1rem}
    .vietnamese{font-size:1rem}
    
    /* Study Tools */
    .study-tools{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}
    .tool-card{background:var(--bg);border:2px solid var(--border);border-radius:12px;padding:1.5rem;flex:1;min-width:250px;text-align:center;cursor:pointer;transition:all 0.3s ease}
    .tool-card:hover{border-color:var(--primary);transform:translateY(-4px);box-shadow:var(--shadow-lg)}
    .tool-icon{font-size:2rem;margin-bottom:0.5rem}
    .tool-title{font-weight:600;margin-bottom:0.25rem}
    .tool-desc{color:var(--fg-muted);font-size:0.9rem}
    
    /* Stats */
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
    .stat-card{background:var(--bg);border-radius:12px;padding:1.5rem;text-align:center;box-shadow:var(--shadow);border-left:4px solid var(--primary)}
    .stat-number{font-size:2rem;font-weight:700;color:var(--primary);margin-bottom:0.25rem}
    .stat-label{color:var(--fg-muted);font-size:0.9rem}
    
    /* Responsive */
    @media (max-width: 768px){
      .nav-content,.controls{flex-direction:column;align-items:stretch}
      input[type=search]{min-width:auto}
      .study-tools{flex-direction:column}
      table{font-size:0.9rem}
      thead th,tbody td{padding:0.75rem 0.5rem}
      .chinese{font-size:1.2rem}
      .modal-header{flex-direction:column;gap:1rem}
      .modal-header > div{justify-content:center}
      #quizOptions{font-size:0.9rem}
    }
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn 0.5s ease-out}
    
    @keyframes pulse{
      0%{transform:scale(1)}
      50%{transform:scale(1.1)}
      100%{transform:scale(1)}
    }
    
    /* Modal */
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(5px)}
    .modal-content{background:var(--bg);border-radius:12px;padding:2rem;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
    .modal-title{font-size:1.5rem;font-weight:700;margin:0}
    .close-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--fg-muted);padding:0}
    .close-btn:hover{color:var(--danger)}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“š Tá»« vá»±ng Trung-Viá»‡t</h1>
    <p class="sub">á»¨ng dá»¥ng há»c tá»« vá»±ng tiáº¿ng Trung vá»›i nhiá»u tÃ­nh nÄƒng thÃ´ng minh</p>
  </header>
  
  <nav class="nav">
    <div class="nav-content">
      <button class="theme-toggle" id="themeToggle">
        <span id="themeIcon">ğŸŒ™</span>
        <span id="themeText">Cháº¿ Ä‘á»™ tá»‘i</span>
      </button>
    </div>
  </nav>

  <main>
    <!-- Stats -->
    <div class="stats fade-in">
      <div class="stat-card">
        <div class="stat-number" id="totalWords">30</div>
        <div class="stat-label">Tá»•ng tá»« vá»±ng</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="studiedWords">0</div>
        <div class="stat-label">ÄÃ£ há»c</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="favoriteWords">0</div>
        <div class="stat-label">YÃªu thÃ­ch</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="accuracy">0%</div>
        <div class="stat-label">Äá»™ chÃ­nh xÃ¡c</div>
      </div>
    </div>

    <!-- Study Tools -->
    <div class="study-tools fade-in">
      <div class="tool-card" onclick="openFlashcards()">
        <div class="tool-icon">ğŸ—‚ï¸</div>
        <div class="tool-title">Flashcard</div>
        <div class="tool-desc">Há»c tá»« vá»±ng vá»›i tháº» ghi nhá»›</div>
      </div>
      <div class="tool-card" onclick="openQuiz()">
        <div class="tool-icon">ğŸ§ </div>
        <div class="tool-title">Kiá»ƒm tra</div>
        <div class="tool-desc">LÃ m bÃ i quiz Ä‘á»ƒ Ã´n táº­p</div>
      </div>
      <div class="tool-card" onclick="getRandomWord()">
        <div class="tool-icon">ğŸ²</div>
        <div class="tool-title">Tá»« ngáº«u nhiÃªn</div>
        <div class="tool-desc">Luyá»‡n tá»« vá»±ng báº¥t ká»³</div>
      </div>
    </div>

    <!-- Search Controls -->
    <div class="controls fade-in">
      <input id="q" type="search" placeholder="ğŸ” TÃ¬m kiáº¿m: è¢« / bei / 'ná»— lá»±c'â€¦" autofocus />
      <button id="export">ğŸ“¥ Xuáº¥t CSV</button>
      <button id="clear">ğŸ—‘ï¸ XÃ³a tÃ¬m</button>
      <button id="randomBtn">ğŸ² Ngáº«u nhiÃªn</button>
      <div id="audioTip" style="background:var(--bg-tertiary);color:var(--fg-secondary);padding:0.5rem 1rem;border-radius:8px;font-size:0.9rem;display:none">
        ğŸ’¡ <strong>Máº¹o:</strong> TrÃªn Ä‘iá»‡n thoáº¡i, hÃ£y cháº¡m vÃ o nÃºt ğŸ”Š Ä‘á»ƒ phÃ¡t Ã¢m tá»« vá»±ng tiáº¿ng Trung
      </div>
    </div>

    <!-- Vocabulary Table -->
    <div class="card fade-in">
      <div class="table-container">
        <table id="tbl">
          <thead>
            <tr>
              <th class="idx">#</th>
              <th>ç¹é«”</th>
              <th>Pinyin</th>
              <th>NghÄ©a tiáº¿ng Viá»‡t</th>
              <th>Thao tÃ¡c</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Flashcard Modal -->
  <div class="modal" id="flashcardModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ—‚ï¸ Flashcard</h2>
        <button class="close-btn" onclick="closeModal('flashcardModal')">&times;</button>
      </div>
      <div id="flashcardContent">
        <div style="text-align:center;padding:2rem">
          <div id="flashcardChinese" style="font-size:3rem;margin-bottom:1rem;color:var(--primary)"></div>
          <div id="flashcardPinyin" style="font-size:1.5rem;color:var(--fg-secondary);margin-bottom:1rem;display:none"></div>
          <div id="flashcardVietnamese" style="font-size:1.2rem;display:none"></div>
          <div style="margin-top:2rem;display:flex;gap:1rem;justify-content:center">
            <button id="revealBtn" class="btn-primary">Hiá»‡n Ä‘Ã¡p Ã¡n</button>
            <button id="nextCardBtn" style="display:none">Tá»« tiáº¿p theo</button>
            <button onclick="speakChinese()" style="background:var(--success);color:white;border-color:var(--success)">ğŸ”Š PhÃ¡t Ã¢m</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div class="modal" id="quizModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ§  Kiá»ƒm tra tá»« vá»±ng</h2>
        <div style="display:flex;gap:1rem;align-items:center">
          <div style="background:var(--bg-secondary);padding:0.5rem 1rem;border-radius:6px;font-size:0.9rem">
            Tiáº¿n Ä‘á»™: <span id="quizProgress" style="font-weight:600;color:var(--primary)">0/30</span>
          </div>
          <button onclick="resetQuiz()" style="background:var(--warning);color:white;border:none;border-radius:6px;padding:0.5rem;font-size:0.9rem;cursor:pointer" title="Báº¯t Ä‘áº§u láº¡i tá»« Ä‘áº§u">
            ğŸ”„
          </button>
          <button class="close-btn" onclick="closeModal('quizModal')">&times;</button>
        </div>
      </div>
      <div id="quizContent">
        <div id="quizQuestion" style="text-align:center;padding:2rem">
          <div id="quizChinese" style="font-size:2.5rem;margin-bottom:1rem;color:var(--primary)"></div>
          <div id="quizPinyin" style="font-size:1.2rem;color:var(--fg-secondary);margin-bottom:2rem"></div>
          <div id="quizOptions" style="display:grid;gap:1rem;max-width:400px;margin:0 auto"></div>
          <div id="quizResult" style="margin-top:1rem;display:none"></div>
          <div style="margin-top:2rem">
            <button id="nextQuestionBtn" style="display:none" class="btn-primary">CÃ¢u tiáº¿p theo</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const DATA = [{"ç¹é«”":"è¢«","Pinyin":"bÃ¨i","NghÄ©a tiáº¿ng Viá»‡t":"bá»‹ (bá»‹ Ä‘á»™ng)"},{"ç¹é«”":"éŠæˆ²","Pinyin":"yÃ³uxÃ¬","NghÄ©a tiáº¿ng Viá»‡t":"trÃ² chÆ¡i"},{"ç¹é«”":"åƒå…‰äº†","Pinyin":"chÄ« guÄng le","NghÄ©a tiáº¿ng Viá»‡t":"Äƒn háº¿t rá»“i"},{"ç¹é«”":"å…¶ä»–åœ°æ–¹","Pinyin":"qÃ­tÄ dÃ¬fÄng","NghÄ©a tiáº¿ng Viá»‡t":"nÆ¡i khÃ¡c"},{"ç¹é«”":"æ¬ä¸äº†","Pinyin":"bÄn bÃ¹ liÇo","NghÄ©a tiáº¿ng Viá»‡t":"khÃ´ng dá»n\/khÃ´ng mang Ä‘Æ°á»£c"},{"ç¹é«”":"å…¬å¯“","Pinyin":"gÅngyÃ¹","NghÄ©a tiáº¿ng Viá»‡t":"cÄƒn há»™"},{"ç¹é«”":"æ—…éŠ","Pinyin":"lÇšyÃ³u","NghÄ©a tiáº¿ng Viá»‡t":"du lá»‹ch"},{"ç¹é«”":"èˆˆè¶£","Pinyin":"xÃ¬ngqÃ¹","NghÄ©a tiáº¿ng Viá»‡t":"há»©ng thÃº, sá»Ÿ thÃ­ch"},{"ç¹é«”":"æ‰","Pinyin":"diÃ o","NghÄ©a tiáº¿ng Viá»‡t":"rÆ¡i, máº¥t"},{"ç¹é«”":"ç·Šå¼µäº†","Pinyin":"jÇnzhÄng le","NghÄ©a tiáº¿ng Viá»‡t":"cÄƒng tháº³ng rá»“i"},{"ç¹é«”":"å°å¿ƒ","Pinyin":"xiÇoxÄ«n","NghÄ©a tiáº¿ng Viá»‡t":"cáº©n tháº­n"},{"ç¹é«”":"æ–°é®®","Pinyin":"xÄ«nxiÄn","NghÄ©a tiáº¿ng Viá»‡t":"tÆ°Æ¡i, má»›i (thÆ°á»ng dÃ¹ng cho Ä‘á»“ Äƒn)"},{"ç¹é«”":"èµ·åºŠ","Pinyin":"qÇchuÃ¡ng","NghÄ©a tiáº¿ng Viá»‡t":"thá»©c dáº­y"},{"ç¹é«”":"é¤…ä¹¾","Pinyin":"bÇnggÄn","NghÄ©a tiáº¿ng Viá»‡t":"bÃ¡nh quy"},{"ç¹é«”":"è€Œä¸”","Pinyin":"Ã©rqiÄ›","NghÄ©a tiáº¿ng Viá»‡t":"hÆ¡n ná»¯a, mÃ  cÃ²n"},{"ç¹é«”":"é›–ç„¶","Pinyin":"suÄ«rÃ¡n","NghÄ©a tiáº¿ng Viá»‡t":"máº·c dÃ¹"},{"ç¹é«”":"ç›¸ä¿¡","Pinyin":"xiÄngxÃ¬n","NghÄ©a tiáº¿ng Viá»‡t":"tin tÆ°á»Ÿng"},{"ç¹é«”":"æ–¼æ˜¯","Pinyin":"yÃºshÃ¬","NghÄ©a tiáº¿ng Viá»‡t":"tháº¿ lÃ , váº­y nÃªn"},{"ç¹é«”":"ä¿è­·","Pinyin":"bÇohÃ¹","NghÄ©a tiáº¿ng Viá»‡t":"báº£o vá»‡"},{"ç¹é«”":"ä½œè€…","Pinyin":"zuÃ²zhÄ›","NghÄ©a tiáº¿ng Viá»‡t":"tÃ¡c giáº£"},{"ç¹é«”":"èŠå¤©","Pinyin":"liÃ¡otiÄn","NghÄ©a tiáº¿ng Viá»‡t":"nÃ³i chuyá»‡n, tÃ¡n gáº«u"},{"ç¹é«”":"æ³¨æ„","Pinyin":"zhÃ¹yÃ¬","NghÄ©a tiáº¿ng Viá»‡t":"chÃº Ã½"},{"ç¹é«”":"æ ¡é•·","Pinyin":"xiÃ ozhÇng","NghÄ©a tiáº¿ng Viá»‡t":"hiá»‡u trÆ°á»Ÿng"},{"ç¹é«”":"é‚€è«‹","Pinyin":"yÄoqÇng","NghÄ©a tiáº¿ng Viá»‡t":"má»i"},{"ç¹é«”":"è¬›å®Œ","Pinyin":"jiÇng wÃ¡n","NghÄ©a tiáº¿ng Viá»‡t":"nÃ³i xong"},{"ç¹é«”":"æ¥è‘—","Pinyin":"jiÄ“zhe","NghÄ©a tiáº¿ng Viá»‡t":"tiáº¿p theo"},{"ç¹é«”":"å¯¦éš›","Pinyin":"shÃ­jÃ¬","NghÄ©a tiáº¿ng Viá»‡t":"thá»±c táº¿"},{"ç¹é«”":"å…¬å‘Š","Pinyin":"gÅnggÃ o","NghÄ©a tiáº¿ng Viá»‡t":"thÃ´ng bÃ¡o"},{"ç¹é«”":"åŠªåŠ›","Pinyin":"nÇ”lÃ¬","NghÄ©a tiáº¿ng Viá»‡t":"ná»— lá»±c, cá»‘ gáº¯ng"},{"ç¹é«”":"äº‹æƒ…","Pinyin":"shÃ¬qÃ­ng","NghÄ©a tiáº¿ng Viá»‡t":"sá»± viá»‡c, chuyá»‡n"}];
    
    // Global state
    let currentTheme = localStorage.getItem('theme') || 'light';
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let studiedWords = JSON.parse(localStorage.getItem('studiedWords') || '[]');
    let quizStats = JSON.parse(localStorage.getItem('quizStats') || '{"correct": 0, "total": 0}');
    let currentFlashcard = 0;
    let currentQuiz = null;
    let speechInitialized = false;
    let isPlayingAudio = false;
    let usedQuizWords = new Set(); // Track words already used in current quiz session
    
    // DOM elements
    const q = document.getElementById('q');
    const tbody = document.querySelector('#tbl tbody');
    
    // Initialize app
    function init() {
      applyTheme(currentTheme);
      updateStats();
      render();
      setupEventListeners();
      showMobileTip();
    }
    
    // Show mobile audio tip
    function showMobileTip() {
      // Check if user is on mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const tipElement = document.getElementById('audioTip');
      
      if (isMobile && tipElement) {
        // Show tip after a delay
        setTimeout(() => {
          tipElement.style.display = 'block';
          tipElement.style.animation = 'fadeIn 0.5s ease-out';
          
          // Hide tip after 5 seconds
          setTimeout(() => {
            tipElement.style.opacity = '0';
            tipElement.style.transition = 'opacity 0.5s ease-out';
            setTimeout(() => {
              tipElement.style.display = 'none';
            }, 500);
          }, 5000);
        }, 2000);
      }
    }
    
    // Theme management
    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      applyTheme(currentTheme);
      localStorage.setItem('theme', currentTheme);
    }
    
    function applyTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      const themeIcon = document.getElementById('themeIcon');
      const themeText = document.getElementById('themeText');
      if (theme === 'dark') {
        themeIcon.textContent = 'â˜€ï¸';
        themeText.textContent = 'Cháº¿ Ä‘á»™ sÃ¡ng';
      } else {
        themeIcon.textContent = 'ğŸŒ™';
        themeText.textContent = 'Cháº¿ Ä‘á»™ tá»‘i';
      }
    }
    
    // Statistics
    function updateStats() {
      document.getElementById('totalWords').textContent = DATA.length;
      document.getElementById('studiedWords').textContent = studiedWords.length;
      document.getElementById('favoriteWords').textContent = favorites.length;
      const accuracy = quizStats.total > 0 ? Math.round((quizStats.correct / quizStats.total) * 100) : 0;
      document.getElementById('accuracy').textContent = accuracy + '%';
    }
    
    // Utility functions
    function strip(s) {
      return (s || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    
    function isFavorite(word) {
      return favorites.some(fav => fav['ç¹é«”'] === word['ç¹é«”']);
    }
    
    function toggleFavorite(word) {
      const index = favorites.findIndex(fav => fav['ç¹é«”'] === word['ç¹é«”']);
      if (index > -1) {
        favorites.splice(index, 1);
      } else {
        favorites.push(word);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateStats();
      render();
    }
    
    function markAsStudied(word) {
      if (!studiedWords.some(studied => studied['ç¹é«”'] === word['ç¹é«”'])) {
        studiedWords.push(word);
        localStorage.setItem('studiedWords', JSON.stringify(studiedWords));
        updateStats();
      }
    }
    
    // Render table
    function render() {
      const term = strip(q.value.trim());
      const rows = DATA.filter(r => !term || strip([r["ç¹é«”"], r["Pinyin"], r["NghÄ©a tiáº¿ng Viá»‡t"]].join(' ')).includes(term));
      
      tbody.innerHTML = rows.map((r, i) => `
        <tr>
          <td class="idx">${i + 1}</td>
          <td class="chinese">${r["ç¹é«”"]}</td>
          <td class="pinyin">${r["Pinyin"]}</td>
          <td class="vietnamese">${r["NghÄ©a tiáº¿ng Viá»‡t"]}</td>
          <td>
            <button onclick="toggleFavorite(DATA[${DATA.indexOf(r)}])" style="background:${isFavorite(r) ? 'var(--danger)' : 'var(--bg)'};color:${isFavorite(r) ? 'white' : 'var(--fg)'};border-color:${isFavorite(r) ? 'var(--danger)' : 'var(--border)'};padding:0.5rem;margin-right:0.5rem">
              ${isFavorite(r) ? 'â¤ï¸' : 'ğŸ¤'}
            </button>
            <button onclick="speakChinese('${r["ç¹é«”"]}')" style="background:var(--success);color:white;border-color:var(--success);padding:0.5rem" title="PhÃ¡t Ã¢m">
              ğŸ”Š
            </button>
          </td>
        </tr>
      `).join('');
    }
    
    // Initialize speech synthesis for mobile compatibility
    function initializeSpeech() {
      if (!speechInitialized && 'speechSynthesis' in window) {
        try {
          // Create a dummy utterance to initialize speech synthesis on mobile
          const testUtterance = new SpeechSynthesisUtterance('');
          testUtterance.volume = 0;
          speechSynthesis.speak(testUtterance);
          speechInitialized = true;
          console.log('Speech synthesis initialized for mobile');
        } catch (error) {
          console.warn('Failed to initialize speech synthesis:', error);
        }
      }
    }

    // Audio pronunciation with enhanced mobile support
    function speakChinese(text = null) {
      // Initialize speech if not done yet
      if (!speechInitialized) {
        initializeSpeech();
      }

      if (!text) {
        const flashcardChinese = document.getElementById('flashcardChinese');
        text = flashcardChinese ? flashcardChinese.textContent : '';
      }
      
      if (!text) {
        console.warn('No text to speak');
        return;
      }

      if (!('speechSynthesis' in window)) {
        alert('TrÃ¬nh duyá»‡t cá»§a báº¡n khÃ´ng há»— trá»£ phÃ¡t Ã¢m tá»± Ä‘á»™ng. Vui lÃ²ng sá»­ dá»¥ng trÃ¬nh duyá»‡t khÃ¡c hoáº·c cáº­p nháº­t lÃªn phiÃªn báº£n má»›i nháº¥t.');
        return;
      }

      // Stop any currently playing speech
      if (isPlayingAudio) {
        speechSynthesis.cancel();
        isPlayingAudio = false;
        updateAudioButtons(false);
        return;
      }

      try {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.8;
        utterance.volume = 1.0;
        utterance.pitch = 1.0;

        // Add event listeners for better feedback
        utterance.onstart = function() {
          isPlayingAudio = true;
          updateAudioButtons(true);
          console.log('Started speaking:', text);
        };

        utterance.onend = function() {
          isPlayingAudio = false;
          updateAudioButtons(false);
          console.log('Finished speaking:', text);
        };

        utterance.onerror = function(event) {
          isPlayingAudio = false;
          updateAudioButtons(false);
          console.error('Speech synthesis error:', event.error);
          
          // Try fallback TTS before showing error
          console.log('Attempting fallback TTS...');
          const fallbackAudio = fallbackTTS(text);
          
          if (!fallbackAudio) {
            // Show user-friendly error message only if fallback also fails
            if (event.error === 'network') {
              alert('Lá»—i káº¿t ná»‘i máº¡ng. Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i internet vÃ  thá»­ láº¡i.');
            } else if (event.error === 'not-allowed') {
              alert('Vui lÃ²ng cho phÃ©p trÃ¬nh duyá»‡t phÃ¡t Ã¢m thanh. Kiá»ƒm tra cÃ i Ä‘áº·t quyá»n cá»§a trÃ¬nh duyá»‡t.');
            } else {
              alert('KhÃ´ng thá»ƒ phÃ¡t Ã¢m thanh. Vui lÃ²ng thá»­ láº¡i hoáº·c sá»­ dá»¥ng trÃ¬nh duyá»‡t khÃ¡c.');
            }
          }
        };

        // For mobile Safari compatibility
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
          // Delay slightly for iOS
          setTimeout(() => {
            speechSynthesis.speak(utterance);
          }, 100);
        } else {
          speechSynthesis.speak(utterance);
        }

      } catch (error) {
        console.error('Error creating speech utterance:', error);
        alert('Lá»—i khi táº¡o Ã¢m thanh. Vui lÃ²ng thá»­ láº¡i.');
        isPlayingAudio = false;
        updateAudioButtons(false);
      }
    }

    // Update audio button appearance
    function updateAudioButtons(isPlaying) {
      const audioButtons = document.querySelectorAll('button[onclick*="speakChinese"]');
      audioButtons.forEach(button => {
        if (isPlaying) {
          button.innerHTML = 'â¹ï¸';
          button.title = 'Dá»«ng phÃ¡t Ã¢m';
          button.style.background = 'var(--warning)';
          button.style.animation = 'pulse 1s infinite';
        } else {
          button.innerHTML = 'ğŸ”Š';
          button.title = 'PhÃ¡t Ã¢m';
          button.style.background = 'var(--success)';
          button.style.animation = 'none';
        }
      });
    }

    // Fallback TTS using Google Translate (for when Web Speech API fails)
    function fallbackTTS(text) {
      if (!text) return;
      
      try {
        // Create an audio element with Google Translate TTS
        const audio = new Audio();
        const encodedText = encodeURIComponent(text);
        audio.src = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=zh-cn&client=tw-ob`;
        audio.crossOrigin = 'anonymous';
        
        audio.onloadstart = function() {
          isPlayingAudio = true;
          updateAudioButtons(true);
          console.log('Fallback TTS started for:', text);
        };
        
        audio.onended = function() {
          isPlayingAudio = false;
          updateAudioButtons(false);
          console.log('Fallback TTS ended for:', text);
        };
        
        audio.onerror = function(error) {
          isPlayingAudio = false;
          updateAudioButtons(false);
          console.error('Fallback TTS error:', error);
          alert('KhÃ´ng thá»ƒ phÃ¡t Ã¢m thanh. Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i internet vÃ  thá»­ láº¡i.');
        };
        
        audio.play().catch(error => {
          console.error('Failed to play fallback audio:', error);
          isPlayingAudio = false;
          updateAudioButtons(false);
          alert('KhÃ´ng thá»ƒ phÃ¡t Ã¢m thanh. TrÃ¬nh duyá»‡t cÃ³ thá»ƒ Ä‘Ã£ cháº·n tá»± Ä‘á»™ng phÃ¡t audio.');
        });
        
        return audio;
      } catch (error) {
        console.error('Error creating fallback TTS:', error);
        alert('KhÃ´ng thá»ƒ khá»Ÿi táº¡o Ã¢m thanh dá»± phÃ²ng.');
        return null;
      }
    }
    
    // Export CSV
    function exportCSV() {
      const header = ["#", "ç¹é«”", "Pinyin", "NghÄ©a tiáº¿ng Viá»‡t"];
      const term = strip(q.value.trim());
      const rows = DATA.filter(r => !term || strip([r["ç¹é«”"], r["Pinyin"], r["NghÄ©a tiáº¿ng Viá»‡t"]].join(' ')).includes(term));
      const lines = [header.join(',')].concat(rows.map((r, i) => [i + 1, r["ç¹é«”"], r["Pinyin"], `"${r["NghÄ©a tiáº¿ng Viá»‡t"].replace(/"/g, '""')}"`].join(',')));
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'vocab-30.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // Random word
    function getRandomWord() {
      const randomWord = DATA[Math.floor(Math.random() * DATA.length)];
      q.value = randomWord["ç¹é«”"];
      render();
      q.focus();
    }
    
    // Modal management
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Flashcard functionality
    function openFlashcards() {
      currentFlashcard = 0;
      showFlashcard();
      document.getElementById('flashcardModal').style.display = 'flex';
    }
    
    function showFlashcard() {
      if (currentFlashcard >= DATA.length) currentFlashcard = 0;
      
      const word = DATA[currentFlashcard];
      document.getElementById('flashcardChinese').textContent = word["ç¹é«”"];
      document.getElementById('flashcardPinyin').textContent = word["Pinyin"];
      document.getElementById('flashcardVietnamese').textContent = word["NghÄ©a tiáº¿ng Viá»‡t"];
      
      // Reset visibility
      document.getElementById('flashcardPinyin').style.display = 'none';
      document.getElementById('flashcardVietnamese').style.display = 'none';
      document.getElementById('revealBtn').style.display = 'inline-flex';
      document.getElementById('nextCardBtn').style.display = 'none';
    }
    
    function revealAnswer() {
      document.getElementById('flashcardPinyin').style.display = 'block';
      document.getElementById('flashcardVietnamese').style.display = 'block';
      document.getElementById('revealBtn').style.display = 'none';
      document.getElementById('nextCardBtn').style.display = 'inline-flex';
      
      markAsStudied(DATA[currentFlashcard]);
    }
    
    function nextFlashcard() {
      currentFlashcard = (currentFlashcard + 1) % DATA.length;
      showFlashcard();
    }
    
    // Quiz functionality
    function openQuiz() {
      updateQuizProgress(); // Initialize progress display
      startNewQuiz();
      document.getElementById('quizModal').style.display = 'flex';
    }
    
    function startNewQuiz() {
      // Get available words (not used yet)
      const availableWords = DATA.filter(word => !usedQuizWords.has(word["ç¹é«”"]));
      
      // If all words have been used, reset and start over
      if (availableWords.length === 0) {
        usedQuizWords.clear();
        showQuizCompletionMessage();
        return;
      }
      
      // Select random word from available words
      const randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
      usedQuizWords.add(randomWord["ç¹é«”"]);
      
      // Get other words for wrong options (excluding the correct one)
      const otherWords = DATA.filter(w => w !== randomWord);
      const wrongOptions = [];
      
      while (wrongOptions.length < 3 && otherWords.length > 0) {
        const randomIndex = Math.floor(Math.random() * otherWords.length);
        wrongOptions.push(otherWords.splice(randomIndex, 1)[0]);
      }
      
      const allOptions = [randomWord, ...wrongOptions].sort(() => Math.random() - 0.5);
      
      currentQuiz = {
        correct: randomWord,
        options: allOptions,
        answered: false
      };
      
      document.getElementById('quizChinese').textContent = randomWord["ç¹é«”"];
      document.getElementById('quizPinyin').textContent = randomWord["Pinyin"];
      
      const optionsContainer = document.getElementById('quizOptions');
      optionsContainer.innerHTML = allOptions.map((option, i) => `
        <button onclick="selectQuizOption(${i})" style="padding:1rem;border:2px solid var(--border);border-radius:8px;background:var(--bg);color:var(--fg);cursor:pointer;transition:all 0.3s ease" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
          ${option["NghÄ©a tiáº¿ng Viá»‡t"]}
        </button>
      `).join('');
      
      // Update quiz progress display
      updateQuizProgress();
      
      document.getElementById('quizResult').style.display = 'none';
      document.getElementById('nextQuestionBtn').style.display = 'none';
    }

    function showQuizCompletionMessage() {
      const resultDiv = document.getElementById('quizResult');
      resultDiv.innerHTML = `
        <div style="padding:1.5rem;border-radius:8px;background:var(--success);color:white;margin-top:1rem;text-align:center">
          <strong>ğŸ‰ ChÃºc má»«ng!</strong><br>
          Báº¡n Ä‘Ã£ hoÃ n thÃ nh táº¥t cáº£ ${DATA.length} tá»« vá»±ng!<br>
          <button onclick="resetQuiz()" style="margin-top:1rem;background:white;color:var(--success);border:2px solid white;border-radius:6px;padding:0.5rem 1rem;font-weight:600;cursor:pointer">
            ğŸ”„ Báº¯t Ä‘áº§u láº¡i
          </button>
        </div>
      `;
      resultDiv.style.display = 'block';
      document.getElementById('nextQuestionBtn').style.display = 'none';
    }

    function updateQuizProgress() {
      const progress = usedQuizWords.size;
      const total = DATA.length;
      const progressElement = document.getElementById('quizProgress');
      if (progressElement) {
        progressElement.textContent = `${progress}/${total}`;
      }
    }

    function resetQuiz() {
      if (usedQuizWords.size > 0) {
        if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n báº¯t Ä‘áº§u láº¡i tá»« Ä‘áº§u? Tiáº¿n Ä‘á»™ hiá»‡n táº¡i sáº½ bá»‹ máº¥t.')) {
          return;
        }
      }
      usedQuizWords.clear();
      startNewQuiz();
      
      // Show brief notification
      const resultDiv = document.getElementById('quizResult');
      resultDiv.innerHTML = `
        <div style="padding:1rem;border-radius:8px;background:var(--primary);color:white;margin-top:1rem;text-align:center">
          ğŸ”„ ÄÃ£ khá»Ÿi táº¡o láº¡i quiz vá»›i táº¥t cáº£ ${DATA.length} tá»« vá»±ng
        </div>
      `;
      resultDiv.style.display = 'block';
      
      // Hide notification after 2 seconds
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 2000);
    }
    
    function selectQuizOption(optionIndex) {
      if (currentQuiz.answered) return;
      
      currentQuiz.answered = true;
      const selectedOption = currentQuiz.options[optionIndex];
      const isCorrect = selectedOption === currentQuiz.correct;
      
      // Update quiz stats
      quizStats.total++;
      if (isCorrect) quizStats.correct++;
      localStorage.setItem('quizStats', JSON.stringify(quizStats));
      updateStats();
      
      // Show result
      const resultDiv = document.getElementById('quizResult');
      resultDiv.innerHTML = `
        <div style="padding:1rem;border-radius:8px;background:${isCorrect ? 'var(--success)' : 'var(--danger)'};color:white;margin-top:1rem">
          <strong>${isCorrect ? 'âœ… ChÃ­nh xÃ¡c!' : 'âŒ Sai rá»“i!'}</strong><br>
          ÄÃ¡p Ã¡n Ä‘Ãºng: ${currentQuiz.correct["NghÄ©a tiáº¿ng Viá»‡t"]}
        </div>
      `;
      resultDiv.style.display = 'block';
      document.getElementById('nextQuestionBtn').style.display = 'inline-flex';
      
      if (isCorrect) markAsStudied(currentQuiz.correct);
    }
    
    function nextQuestion() {
      startNewQuiz();
    }
    
    // Event listeners
    function setupEventListeners() {
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      document.getElementById('export').addEventListener('click', exportCSV);
      document.getElementById('clear').addEventListener('click', () => { q.value = ''; render(); });
      document.getElementById('randomBtn').addEventListener('click', getRandomWord);
      q.addEventListener('input', render);
      
      // Flashcard events
      document.getElementById('revealBtn').addEventListener('click', revealAnswer);
      document.getElementById('nextCardBtn').addEventListener('click', nextFlashcard);
      document.getElementById('nextQuestionBtn').addEventListener('click', nextQuestion);
      
      // Initialize speech synthesis on first user interaction (for mobile compatibility)
      const firstInteractionEvents = ['click', 'touchstart', 'keydown'];
      const initSpeechOnce = () => {
        initializeSpeech();
        firstInteractionEvents.forEach(event => {
          document.removeEventListener(event, initSpeechOnce, true);
        });
      };
      
      firstInteractionEvents.forEach(event => {
        document.addEventListener(event, initSpeechOnce, true);
      });
      
      // Close modals when clicking outside
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
