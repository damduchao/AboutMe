<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc Ti·∫øng Trung Ph·ªìn Th·ªÉ - Gemini AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .settings-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .nav-tab {
            flex: 1;
            min-width: 150px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lesson-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .lesson-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .lesson-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .lesson-card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .lesson-card .vocab-count {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .lesson-card .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: background 0.3s;
        }

        .lesson-card .delete-btn:hover {
            background: rgba(255,0,0,0.8);
        }

        .add-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.3s;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .add-btn:hover {
            transform: scale(1.05);
        }

        .add-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 700px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        .form-group textarea {
            min-height: 150px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s;
        }

        .btn:hover {
            transform: scale(1.02);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .flashcard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }

        .flashcard {
            width: 500px;
            height: 350px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
            margin: 20px 0;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            border-radius: 20px;
        }

        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flashcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }

        .flashcard-text {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }

        .flashcard-sub {
            font-size: 1.2em;
            opacity: 0.9;
            text-align: center;
        }

        .speak-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: background 0.3s;
            font-weight: 600;
        }

        .speak-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .flashcard-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .control-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s;
        }

        .control-btn:hover {
            transform: scale(1.05);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .vocab-list {
            margin-top: 20px;
        }

        .vocab-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }

        .vocab-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .vocab-info {
            flex: 1;
        }

        .vocab-chinese {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .vocab-pinyin {
            color: #666;
            margin-bottom: 3px;
        }

        .vocab-vietnamese {
            color: #333;
        }

        .vocab-actions {
            display: flex;
            gap: 10px;
        }

        .vocab-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .vocab-delete:hover {
            background: #c82333;
        }

        .vocab-speak {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .vocab-speak:hover {
            background: #218838;
        }

        .exercise-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .question-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .question-chinese {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            text-align: center;
        }

        .options {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .option-btn {
            background: white;
            border: 2px solid #e9ecef;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .option-btn:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .option-btn.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .option-btn.incorrect {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .score-display {
            text-align: center;
            font-size: 1.5em;
            margin: 20px 0;
            color: #667eea;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.3em;
        }

        .ai-chat-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-messages {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            max-width: 80%;
        }

        .chat-message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
        }

        .chat-message.ai {
            background: white;
            color: #333;
            border: 2px solid #e9ecef;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hint {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .flashcard {
                width: 90%;
                height: 300px;
            }

            .flashcard-text {
                font-size: 2em;
            }

            h1 {
                font-size: 1.8em;
            }

            .nav-tab {
                padding: 15px 10px;
                font-size: 0.9em;
            }

            .lesson-list {
                grid-template-columns: 1fr;
            }

            .settings-btn {
                position: static;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="settings-btn" onclick="showSettingsModal()">‚öôÔ∏è C√†i ƒë·∫∑t</button>
            <h1>üìö H·ªçc Ti·∫øng Trung Ph·ªìn Th·ªÉ</h1>
            <div class="subtitle">ƒê√†i Loan - Traditional Chinese - Powered by Gemini 1.5 Flash ‚ö°</div>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('lessons')">üìã B√†i h·ªçc</button>
            <button class="nav-tab" onclick="switchTab('flashcards')">üé¥ Flashcards</button>
            <button class="nav-tab" onclick="switchTab('exercises')">‚úçÔ∏è B√†i t·∫≠p</button>
            <button class="nav-tab" onclick="switchTab('ai-chat')">ü§ñ AI Tr·ª£ l√Ω</button>
        </div>

        <!-- Tab: Qu·∫£n l√Ω b√†i h·ªçc -->
        <div id="lessons-tab" class="tab-content active">
            <div style="background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <strong>üí° M·∫πo:</strong> T·∫•t c·∫£ t√≠nh nƒÉng c∆° b·∫£n (Flashcards, B√†i t·∫≠p, ƒê·ªçc t·ª´ v·ª±ng) ho·∫°t ƒë·ªông <strong>MI·ªÑN PH√ç</strong> kh√¥ng c·∫ßn API key! 
                Ch·ªâ c·∫ßn API key cho AI Chat v√† AI d·ªãch t·ª± ƒë·ªông.
            </div>
            <button class="add-btn" onclick="showAddLessonModal()">‚ûï Th√™m b√†i h·ªçc m·ªõi</button>
            <div id="lesson-list" class="lesson-list"></div>
        </div>

        <!-- Tab: Flashcards -->
        <div id="flashcards-tab" class="tab-content">
            <div class="form-group">
                <label>Ch·ªçn b√†i h·ªçc:</label>
                <select id="flashcard-lesson-select" onchange="loadFlashcards()" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e9ecef; font-size: 1em;">
                    <option value="">-- Ch·ªçn b√†i h·ªçc --</option>
                </select>
            </div>
            <div id="flashcard-area"></div>
        </div>

        <!-- Tab: B√†i t·∫≠p -->
        <div id="exercises-tab" class="tab-content">
            <div class="form-group">
                <label>Ch·ªçn b√†i h·ªçc:</label>
                <select id="exercise-lesson-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e9ecef; font-size: 1em;">
                    <option value="">-- Ch·ªçn b√†i h·ªçc --</option>
                </select>
            </div>
            <button class="add-btn" onclick="startExercise()" style="margin-top: 20px;">üéØ B·∫Øt ƒë·∫ßu l√†m b√†i</button>
            <div id="exercise-area"></div>
        </div>

        <!-- Tab: AI Chat -->
        <div id="ai-chat-tab" class="tab-content">
            <div class="ai-chat-container">
                <h2 style="color: #667eea; margin-bottom: 20px;">ü§ñ Gemini 1.5 Flash - Tr·ª£ l√Ω h·ªçc ti·∫øng Trung</h2>
                <p style="margin-bottom: 20px; color: #666;">
                    H·ªèi Gemini v·ªÅ b·∫•t k·ª≥ ƒëi·ªÅu g√¨: ng·ªØ ph√°p, t·ª´ v·ª±ng, vƒÉn h√≥a, ph√°t √¢m...
                    <strong style="color: #28a745;">MI·ªÑN PH√ç & C·ª∞C NHANH! ‚ö°</strong>
                </p>
                
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message ai">
                        üëã Xin ch√†o! T√¥i l√† <strong>Gemini 1.5 Flash</strong> - tr·ª£ l√Ω h·ªçc ti·∫øng Trung c·ªßa b·∫°n. B·∫°n c·∫ßn t√¥i gi√∫p g√¨? ‚ú®
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button class="add-btn" onclick="sendChatMessage()">G·ª≠i</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: C√†i ƒë·∫∑t -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2>‚öôÔ∏è C√†i ƒë·∫∑t Gemini API Key (T√πy ch·ªçn)</h2>
            
            <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>‚ú® Gemini 1.5 Flash - MI·ªÑN PH√ç & C·ª∞C NHANH!</strong><br>
                ‚Ä¢ <strong>KH√îNG c·∫ßn th·∫ª t√≠n d·ª•ng</strong><br>
                ‚Ä¢ <strong>KH√îNG c·∫ßn n·∫°p ti·ªÅn</strong><br>
                ‚Ä¢ <strong>15 RPM (requests/ph√∫t) FREE</strong> ‚ö°<br>
                ‚Ä¢ Model m·ªõi nh·∫•t c·ªßa Google (2024)<br>
                ‚Ä¢ API key CH·ªà c·∫ßn cho: AI Chat v√† AI d·ªãch t·ª± ƒë·ªông
            </div>
            
            <div style="background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>üí° L∆∞u √Ω:</strong><br>
                T·∫•t c·∫£ t√≠nh nƒÉng kh√°c (Flashcards, B√†i t·∫≠p, ƒê·ªçc t·ª´ v·ª±ng) ho·∫°t ƒë·ªông <strong>MI·ªÑN PH√ç</strong> kh√¥ng c·∫ßn API key!
            </div>
            
            <div class="form-group">
                <label>Google Gemini API Key (Mi·ªÖn ph√≠ - T√πy ch·ªçn):</label>
                <input type="password" id="api-key-input" placeholder="AIza...">
                <div class="hint">Key ƒë∆∞·ª£c l∆∞u an to√†n tr√™n tr√¨nh duy·ªát. <strong>KH√îNG chia s·∫ª key v·ªõi ng∆∞·ªùi kh√°c!</strong></div>
                <div class="hint" style="margin-top: 10px;">
                    <strong>üìç C√°ch l·∫•y Gemini API key (MI·ªÑN PH√ç):</strong><br>
                    1. Truy c·∫≠p: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #667eea;">
                        <strong>Google AI Studio</strong>
                    </a><br>
                    2. ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Google<br>
                    3. Nh·∫•n <strong>"Create API Key"</strong><br>
                    4. Copy key v√† d√°n v√†o ƒë√¢y<br>
                    5. Nh·∫•n L∆∞u - Xong! üéâ
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveSettings()">üíæ L∆∞u</button>
                <button class="btn btn-secondary" onclick="closeModal('settings-modal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Modal: Th√™m b√†i h·ªçc -->
    <div id="add-lesson-modal" class="modal">
        <div class="modal-content">
            <h2>üìù Th√™m b√†i h·ªçc m·ªõi</h2>
            <div class="form-group">
                <label>T√™n b√†i h·ªçc:</label>
                <input type="text" id="lesson-name" placeholder="V√≠ d·ª•: B√†i 1 - Ch√†o h·ªèi">
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addLesson()">Th√™m</button>
                <button class="btn btn-secondary" onclick="closeModal('add-lesson-modal')">H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Modal: Chi ti·∫øt b√†i h·ªçc -->
    <div id="lesson-detail-modal" class="modal">
        <div class="modal-content">
            <h2 id="lesson-detail-title">Chi ti·∫øt b√†i h·ªçc</h2>
            <button class="add-btn" onclick="showAddVocabModal()">‚ûï Th√™m t·ª´ v·ª±ng</button>
            <button class="add-btn secondary" onclick="showBulkAddModal()">üìã Th√™m nhi·ªÅu t·ª´</button>
            <div id="vocab-list" class="vocab-list"></div>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('lesson-detail-modal')">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Modal: Th√™m t·ª´ v·ª±ng -->
    <div id="add-vocab-modal" class="modal">
        <div class="modal-content">
            <h2>‚ûï Th√™m t·ª´ v·ª±ng</h2>
            <div class="form-group">
                <label>Ti·∫øng Trung (Ph·ªìn th·ªÉ):</label>
                <input type="text" id="vocab-chinese" placeholder="‰Ω†Â•Ω">
            </div>
            <div class="form-group">
                <label>Pinyin:</label>
                <input type="text" id="vocab-pinyin" placeholder="n«ê h«éo">
                <button class="add-btn secondary" onclick="autoTranslate()" style="margin-top: 10px;">
                    ü§ñ AI d·ªãch t·ª± ƒë·ªông
                </button>
            </div>
            <div class="form-group">
                <label>Nghƒ©a ti·∫øng Vi·ªát:</label>
                <input type="text" id="vocab-vietnamese" placeholder="Xin ch√†o">
            </div>
            <div id="translate-status"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addVocab()">Th√™m</button>
                <button class="btn btn-secondary" onclick="closeModal('add-vocab-modal')">H·ªßy</button>
            </div>
        </div>
    </div>

    <!-- Modal: Th√™m nhi·ªÅu t·ª´ v·ª±ng -->
    <div id="bulk-add-modal" class="modal">
        <div class="modal-content">
            <h2>üìã Th√™m nhi·ªÅu t·ª´ v·ª±ng</h2>
            <div class="form-group">
                <label>Nh·∫≠p danh s√°ch t·ª´ v·ª±ng (m·ªói d√≤ng m·ªôt t·ª´, ƒë·ªãnh d·∫°ng: Ti·∫øng Trung | Pinyin | Ti·∫øng Vi·ªát):</label>
                <textarea id="bulk-vocab-input" placeholder="‰Ω†Â•Ω | n«ê h«éo | Xin ch√†o&#10;Ë¨ùË¨ù | xi√®xi√® | C·∫£m ∆°n&#10;ÂÜçË¶ã | z√†iji√†n | T·∫°m bi·ªát"></textarea>
                <div class="hint">Ho·∫∑c ch·ªâ nh·∫≠p ti·∫øng Trung, m·ªói d√≤ng m·ªôt t·ª´. AI s·∫Ω t·ª± ƒë·ªông d·ªãch!</div>
            </div>
            <div id="bulk-status"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="bulkAddVocabs()">üì• Th√™m t·∫•t c·∫£</button>
                <button class="btn btn-secondary" onclick="closeModal('bulk-add-modal')">H·ªßy</button>
            </div>
        </div>
    </div>

    <script>
        // D·ªØ li·ªáu
        let lessons = JSON.parse(localStorage.getItem('lessons')) || [];
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let currentLessonId = null;
        let currentFlashcardIndex = 0;
        let currentExerciseIndex = 0;
        let exerciseScore = 0;
        let exerciseVocabs = [];
        let chatHistory = [];

        // Kh·ªüi t·∫°o
        function init() {
            renderLessons();
            updateLessonSelects();
            if (apiKey) {
                document.getElementById('api-key-input').value = apiKey;
            }
        }

        // Chuy·ªÉn tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
        }

        // Modal
        function showSettingsModal() {
            document.getElementById('settings-modal').classList.add('active');
        }

        function showAddLessonModal() {
            document.getElementById('add-lesson-modal').classList.add('active');
        }

        function showAddVocabModal() {
            document.getElementById('add-vocab-modal').classList.add('active');
        }

        function showBulkAddModal() {
            document.getElementById('bulk-add-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // C√†i ƒë·∫∑t
        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('gemini_api_key', key);
                alert('‚úÖ ƒê√£ l∆∞u Gemini API key th√†nh c√¥ng!');
                closeModal('settings-modal');
            } else {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p API key!');
            }
        }

        // Qu·∫£n l√Ω b√†i h·ªçc
        function addLesson() {
            const name = document.getElementById('lesson-name').value.trim();
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n b√†i h·ªçc!');
                return;
            }

            const lesson = {
                id: Date.now(),
                name: name,
                vocabs: []
            };

            lessons.push(lesson);
            saveLessons();
            renderLessons();
            updateLessonSelects();
            closeModal('add-lesson-modal');
            document.getElementById('lesson-name').value = '';
        }

        function deleteLesson(lessonId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i h·ªçc n√†y?')) {
                lessons = lessons.filter(l => l.id !== lessonId);
                saveLessons();
                renderLessons();
                updateLessonSelects();
            }
        }

        function openLessonDetail(lessonId) {
            currentLessonId = lessonId;
            const lesson = lessons.find(l => l.id === lessonId);
            document.getElementById('lesson-detail-title').textContent = lesson.name;
            renderVocabs();
            document.getElementById('lesson-detail-modal').classList.add('active');
        }

        function renderLessons() {
            const container = document.getElementById('lesson-list');
            
            if (lessons.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìö</div>
                        <div class="empty-state-text">Ch∆∞a c√≥ b√†i h·ªçc n√†o. H√£y th√™m b√†i h·ªçc ƒë·∫ßu ti√™n!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = lessons.map(lesson => `
                <div class="lesson-card" onclick="openLessonDetail(${lesson.id})">
                    <button class="delete-btn" onclick="event.stopPropagation(); deleteLesson(${lesson.id})">√ó</button>
                    <h3>${lesson.name}</h3>
                    <div class="vocab-count">üìù ${lesson.vocabs.length} t·ª´ v·ª±ng</div>
                </div>
            `).join('');
        }

        // Text-to-Speech cho ti·∫øng Trung
        function speakChinese(text) {
            if ('speechSynthesis' in window) {
                // D·ª´ng t·∫•t c·∫£ speech ƒëang ch·∫°y
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW'; // Ti·∫øng Trung ƒê√†i Loan
                utterance.rate = 0.8; // T·ªëc ƒë·ªô ch·∫≠m h∆°n ƒë·ªÉ h·ªçc
                utterance.pitch = 1;
                
                window.speechSynthesis.speak(utterance);
            } else {
                alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªçc vƒÉn b·∫£n!');
            }
        }

        // AI Translation with Gemini
        async function autoTranslate() {
            const chinese = document.getElementById('vocab-chinese').value.trim();
            
            if (!chinese) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p t·ª´ ti·∫øng Trung tr∆∞·ªõc!');
                return;
            }

            if (!apiKey) {
                alert('‚ö†Ô∏è Vui l√≤ng c√†i ƒë·∫∑t Gemini API key tr∆∞·ªõc!\n\n1. Nh·∫•n n√∫t C√†i ƒë·∫∑t ·ªü g√≥c tr√™n\n2. Truy c·∫≠p: https://aistudio.google.com/app/apikey\n3. T·∫°o key MI·ªÑN PH√ç (kh√¥ng c·∫ßn th·∫ª t√≠n d·ª•ng)\n4. D√°n v√†o v√† l∆∞u\n\nüí° Ho·∫∑c c√≥ th·ªÉ th√™m t·ª´ v·ª±ng th·ªß c√¥ng kh√¥ng c·∫ßn AI!');
                return;
            }

            const statusDiv = document.getElementById('translate-status');
            statusDiv.innerHTML = '<div style="color: #667eea;">ü§ñ Gemini AI ƒëang d·ªãch... <span class="loading"></span></div>';

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `D·ªãch t·ª´ ti·∫øng Trung Ph·ªìn th·ªÉ (Traditional Chinese) n√†y sang ti·∫øng Vi·ªát v√† cho pinyin. Ch·ªâ tr·∫£ l·ªùi theo ƒë·ªãnh d·∫°ng JSON: {"pinyin": "...", "vietnamese": "..."}\n\nT·ª´ c·∫ßn d·ªãch: ${chinese}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 200
                        }
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ API');
                }

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ Gemini AI');
                }

                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Parse JSON t·ª´ response
                const jsonMatch = aiResponse.match(/\{[^}]+\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    document.getElementById('vocab-pinyin').value = result.pinyin || '';
                    document.getElementById('vocab-vietnamese').value = result.vietnamese || '';
                    statusDiv.innerHTML = '<div class="success-message">‚úÖ D·ªãch th√†nh c√¥ng b·ªüi Gemini AI!</div>';
                } else {
                    // Fallback: parse text th√¥ng th∆∞·ªùng
                    document.getElementById('vocab-vietnamese').value = aiResponse;
                    statusDiv.innerHTML = '<div class="success-message">‚úÖ D·ªãch th√†nh c√¥ng!</div>';
                }

                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);

            } catch (error) {
                console.error('Translation error:', error);
                let errorMessage = error.message;
                if (errorMessage.includes('API_KEY_INVALID') || errorMessage.includes('API key not valid')) {
                    errorMessage = 'üîë Gemini API key kh√¥ng h·ª£p l·ªá!\n\nüìç Gi·∫£i ph√°p:\n1. V√†o C√†i ƒë·∫∑t v√† ki·ªÉm tra l·∫°i key\n2. T·∫°o key m·ªõi t·∫°i: https://aistudio.google.com/app/apikey';
                } else if (errorMessage.includes('quota') || errorMessage.includes('RESOURCE_EXHAUSTED')) {
                    errorMessage = '‚è±Ô∏è ƒê√£ v∆∞·ª£t qu√° gi·ªõi h·∫°n!\n\nüìç ƒê·ª£i 1 ph√∫t v√† th·ª≠ l·∫°i\n(Gemini 1.5 Flash free: 15 requests/ph√∫t)';
                }
                statusDiv.innerHTML = `<div class="error-message">‚ùå ${errorMessage.replace(/\n/g, '<br>')}</div>`;
            }
        }

        // Bulk Add Vocabs
        async function bulkAddVocabs() {
            const input = document.getElementById('bulk-vocab-input').value.trim();
            
            if (!input) {
                alert('‚ö†Ô∏è Vui l√≤ng nh·∫≠p danh s√°ch t·ª´ v·ª±ng!');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim());
            const statusDiv = document.getElementById('bulk-status');
            const lesson = lessons.find(l => l.id === currentLessonId);
            
            let addedCount = 0;
            statusDiv.innerHTML = '<div style="color: #667eea;">üì• ƒêang x·ª≠ l√Ω...</div>';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const parts = line.split('|').map(p => p.trim());

                if (parts.length >= 3) {
                    // ƒê·ªãnh d·∫°ng: Ti·∫øng Trung | Pinyin | Ti·∫øng Vi·ªát
                    lesson.vocabs.push({
                        id: Date.now() + i,
                        chinese: parts[0],
                        pinyin: parts[1],
                        vietnamese: parts[2]
                    });
                    addedCount++;
                } else if (parts.length === 1 && apiKey) {
                    // Ch·ªâ c√≥ ti·∫øng Trung, d√πng Gemini AI d·ªãch
                    statusDiv.innerHTML = `<div style="color: #667eea;">ü§ñ Gemini ƒëang d·ªãch t·ª´ ${i + 1}/${lines.length}...</div>`;
                    
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: `D·ªãch t·ª´ ti·∫øng Trung Ph·ªìn th·ªÉ n√†y sang ti·∫øng Vi·ªát v√† cho pinyin. Ch·ªâ tr·∫£ l·ªùi theo ƒë·ªãnh d·∫°ng JSON: {"pinyin": "...", "vietnamese": "..."}\n\nT·ª´: ${parts[0]}`
                                    }]
                                }],
                                generationConfig: {
                                    temperature: 0.3,
                                    maxOutputTokens: 200
                                }
                            })
                        });

                        const data = await response.json();
                        if (!data.error && data.candidates && data.candidates[0]) {
                            const aiResponse = data.candidates[0].content.parts[0].text;
                            const jsonMatch = aiResponse.match(/\{[^}]+\}/);
                            if (jsonMatch) {
                                const result = JSON.parse(jsonMatch[0]);
                                lesson.vocabs.push({
                                    id: Date.now() + i,
                                    chinese: parts[0],
                                    pinyin: result.pinyin || '',
                                    vietnamese: result.vietnamese || ''
                                });
                                addedCount++;
                            }
                        }
                    } catch (error) {
                        console.error('Error translating:', error);
                    }
                    
                    // Delay to avoid rate limit (Gemini 1.5 Flash free: 15 req/min = 4s per request)
                    await new Promise(resolve => setTimeout(resolve, 4000));
                }
            }

            saveLessons();
            renderVocabs();
            renderLessons();
            
            statusDiv.innerHTML = `<div class="success-message">‚úÖ ƒê√£ th√™m ${addedCount} t·ª´ v·ª±ng!</div>`;
            document.getElementById('bulk-vocab-input').value = '';
            
            setTimeout(() => {
                closeModal('bulk-add-modal');
                statusDiv.innerHTML = '';
            }, 2000);
        }

        // Qu·∫£n l√Ω t·ª´ v·ª±ng
        function addVocab() {
            const chinese = document.getElementById('vocab-chinese').value.trim();
            const pinyin = document.getElementById('vocab-pinyin').value.trim();
            const vietnamese = document.getElementById('vocab-vietnamese').value.trim();

            if (!chinese || !pinyin || !vietnamese) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }

            const lesson = lessons.find(l => l.id === currentLessonId);
            lesson.vocabs.push({
                id: Date.now(),
                chinese,
                pinyin,
                vietnamese
            });

            saveLessons();
            renderVocabs();
            renderLessons();
            closeModal('add-vocab-modal');
            
            document.getElementById('vocab-chinese').value = '';
            document.getElementById('vocab-pinyin').value = '';
            document.getElementById('vocab-vietnamese').value = '';
            document.getElementById('translate-status').innerHTML = '';
        }

        function deleteVocab(vocabId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·ª´ v·ª±ng n√†y?')) {
                const lesson = lessons.find(l => l.id === currentLessonId);
                lesson.vocabs = lesson.vocabs.filter(v => v.id !== vocabId);
                saveLessons();
                renderVocabs();
                renderLessons();
            }
        }

        function renderVocabs() {
            const container = document.getElementById('vocab-list');
            const lesson = lessons.find(l => l.id === currentLessonId);
            
            if (lesson.vocabs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-text">Ch∆∞a c√≥ t·ª´ v·ª±ng n√†o. H√£y th√™m t·ª´ v·ª±ng!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = lesson.vocabs.map(vocab => `
                <div class="vocab-item">
                    <div class="vocab-info">
                        <div class="vocab-chinese">${vocab.chinese}</div>
                        <div class="vocab-pinyin">${vocab.pinyin}</div>
                        <div class="vocab-vietnamese">${vocab.vietnamese}</div>
                    </div>
                    <div class="vocab-actions">
                        <button class="vocab-speak" onclick="speakChinese('${vocab.chinese}')">üîä</button>
                        <button class="vocab-delete" onclick="deleteVocab(${vocab.id})">X√≥a</button>
                    </div>
                </div>
            `).join('');
        }

        // Flashcards
        function updateLessonSelects() {
            const flashcardSelect = document.getElementById('flashcard-lesson-select');
            const exerciseSelect = document.getElementById('exercise-lesson-select');
            
            const options = lessons.map(lesson => 
                `<option value="${lesson.id}">${lesson.name} (${lesson.vocabs.length} t·ª´)</option>`
            ).join('');

            flashcardSelect.innerHTML = '<option value="">-- Ch·ªçn b√†i h·ªçc --</option>' + options;
            exerciseSelect.innerHTML = '<option value="">-- Ch·ªçn b√†i h·ªçc --</option>' + options;
        }

        function loadFlashcards() {
            const lessonId = parseInt(document.getElementById('flashcard-lesson-select').value);
            if (!lessonId) {
                document.getElementById('flashcard-area').innerHTML = '';
                return;
            }

            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson.vocabs.length === 0) {
                document.getElementById('flashcard-area').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üé¥</div>
                        <div class="empty-state-text">B√†i h·ªçc n√†y ch∆∞a c√≥ t·ª´ v·ª±ng!</div>
                    </div>
                `;
                return;
            }

            currentFlashcardIndex = 0;
            renderFlashcard(lesson);
        }

        function renderFlashcard(lesson) {
            const vocab = lesson.vocabs[currentFlashcardIndex];
            const container = document.getElementById('flashcard-area');
            
            container.innerHTML = `
                <div class="flashcard-container">
                    <div style="margin-bottom: 20px; font-size: 1.2em; color: #667eea; font-weight: bold;">
                        T·ª´ ${currentFlashcardIndex + 1} / ${lesson.vocabs.length}
                    </div>
                    <div class="flashcard" id="current-flashcard" onclick="flipCard()">
                        <div class="flashcard-front">
                            <div class="flashcard-text">${vocab.chinese}</div>
                            <div class="flashcard-sub">${vocab.pinyin}</div>
                            <button class="speak-btn" onclick="event.stopPropagation(); speakChinese('${vocab.chinese}')">
                                üîä Nghe ph√°t √¢m
                            </button>
                            <div style="margin-top: 20px; opacity: 0.7;">üëÜ Nh·∫•n ƒë·ªÉ l·∫≠t th·∫ª</div>
                        </div>
                        <div class="flashcard-back">
                            <div class="flashcard-text">${vocab.vietnamese}</div>
                            <div class="flashcard-sub">${vocab.chinese} (${vocab.pinyin})</div>
                            <button class="speak-btn" onclick="event.stopPropagation(); speakChinese('${vocab.chinese}')">
                                üîä Nghe ph√°t √¢m
                            </button>
                            <div style="margin-top: 20px; opacity: 0.7;">üëÜ Nh·∫•n ƒë·ªÉ l·∫≠t th·∫ª</div>
                        </div>
                    </div>
                    <div class="flashcard-controls">
                        <button class="control-btn" style="background: #6c757d; color: white;" 
                                onclick="previousCard()" ${currentFlashcardIndex === 0 ? 'disabled' : ''}>
                            ‚Üê Tr∆∞·ªõc
                        </button>
                        <button class="control-btn" style="background: #667eea; color: white;" 
                                onclick="nextCard()" ${currentFlashcardIndex === lesson.vocabs.length - 1 ? 'disabled' : ''}>
                            Sau ‚Üí
                        </button>
                    </div>
                </div>
            `;
        }

        function flipCard() {
            document.getElementById('current-flashcard').classList.toggle('flipped');
        }

        function previousCard() {
            const lessonId = parseInt(document.getElementById('flashcard-lesson-select').value);
            const lesson = lessons.find(l => l.id === lessonId);
            
            if (currentFlashcardIndex > 0) {
                currentFlashcardIndex--;
                renderFlashcard(lesson);
            }
        }

        function nextCard() {
            const lessonId = parseInt(document.getElementById('flashcard-lesson-select').value);
            const lesson = lessons.find(l => l.id === lessonId);
            
            if (currentFlashcardIndex < lesson.vocabs.length - 1) {
                currentFlashcardIndex++;
                renderFlashcard(lesson);
            }
        }

        // B√†i t·∫≠p
        function startExercise() {
            const lessonId = parseInt(document.getElementById('exercise-lesson-select').value);
            if (!lessonId) {
                alert('Vui l√≤ng ch·ªçn b√†i h·ªçc!');
                return;
            }

            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson.vocabs.length < 2) {
                alert('B√†i h·ªçc c·∫ßn c√≥ √≠t nh·∫•t 2 t·ª´ v·ª±ng ƒë·ªÉ l√†m b√†i t·∫≠p!');
                return;
            }

            exerciseVocabs = [...lesson.vocabs].sort(() => Math.random() - 0.5);
            currentExerciseIndex = 0;
            exerciseScore = 0;
            renderExerciseQuestion();
        }

        function renderExerciseQuestion() {
            if (currentExerciseIndex >= exerciseVocabs.length) {
                showExerciseResult();
                return;
            }

            const container = document.getElementById('exercise-area');
            const correctVocab = exerciseVocabs[currentExerciseIndex];
            const allVocabs = [...exerciseVocabs];
            
            const options = [correctVocab];
            while (options.length < Math.min(4, allVocabs.length)) {
                const randomVocab = allVocabs[Math.floor(Math.random() * allVocabs.length)];
                if (!options.find(v => v.id === randomVocab.id)) {
                    options.push(randomVocab);
                }
            }
            
            options.sort(() => Math.random() - 0.5);

            container.innerHTML = `
                <div class="exercise-container">
                    <div class="score-display">
                        C√¢u ${currentExerciseIndex + 1}/${exerciseVocabs.length} | ƒêi·ªÉm: ${exerciseScore}
                    </div>
                    <div class="question-card">
                        <div class="question-text">T·ª´ n√†y c√≥ nghƒ©a l√† g√¨?</div>
                        <div class="question-chinese">${correctVocab.chinese}</div>
                        <div style="text-align: center; color: #666; margin-top: 10px;">
                            ${correctVocab.pinyin}
                            <button class="speak-btn" onclick="speakChinese('${correctVocab.chinese}')" style="margin-left: 10px; color: #667eea;">
                                üîä Nghe
                            </button>
                        </div>
                        <div class="options">
                            ${options.map((option, index) => `
                                <button class="option-btn" onclick="checkAnswer(${option.id}, ${correctVocab.id})">
                                    ${String.fromCharCode(65 + index)}. ${option.vietnamese}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function checkAnswer(selectedId, correctId) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(btn => btn.disabled = true);

            const selectedBtn = Array.from(buttons).find(btn => 
                btn.onclick.toString().includes(`checkAnswer(${selectedId}`)
            );

            if (selectedId === correctId) {
                selectedBtn.classList.add('correct');
                exerciseScore++;
            } else {
                selectedBtn.classList.add('incorrect');
                const correctBtn = Array.from(buttons).find(btn => 
                    btn.onclick.toString().includes(`checkAnswer(${correctId}`)
                );
                correctBtn.classList.add('correct');
            }

            setTimeout(() => {
                currentExerciseIndex++;
                renderExerciseQuestion();
            }, 1500);
        }

        function showExerciseResult() {
            const container = document.getElementById('exercise-area');
            const percentage = Math.round((exerciseScore / exerciseVocabs.length) * 100);
            
            let message = '';
            if (percentage >= 80) {
                message = 'üéâ Xu·∫•t s·∫Øc!';
            } else if (percentage >= 60) {
                message = 'üëç Kh√° t·ªët!';
            } else {
                message = 'üí™ C·ªë g·∫Øng l√™n!';
            }

            container.innerHTML = `
                <div class="exercise-container">
                    <div class="question-card" style="text-align: center;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üéØ</div>
                        <h2 style="color: #667eea; margin-bottom: 20px;">${message}</h2>
                        <div class="score-display" style="font-size: 2em;">
                            ƒêi·ªÉm: ${exerciseScore}/${exerciseVocabs.length}
                        </div>
                        <div style="font-size: 1.5em; margin: 20px 0; color: #666;">
                            ${percentage}%
                        </div>
                        <button class="add-btn" onclick="startExercise()">
                            üîÑ L√†m l·∫°i
                        </button>
                    </div>
                </div>
            `;
        }

        // AI Chat with Gemini
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!apiKey) {
                alert('‚ö†Ô∏è Vui l√≤ng c√†i ƒë·∫∑t Gemini API key tr∆∞·ªõc!\n\n1. Nh·∫•n n√∫t C√†i ƒë·∫∑t\n2. Truy c·∫≠p: https://aistudio.google.com/app/apikey\n3. T·∫°o key MI·ªÑN PH√ç\n4. D√°n v√†o v√† l∆∞u');
                return;
            }

            const chatContainer = document.getElementById('chat-messages');
            
            // Hi·ªÉn th·ªã tin nh·∫Øn user
            chatContainer.innerHTML += `
                <div class="chat-message user">${message}</div>
            `;
            
            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Hi·ªÉn th·ªã loading
            chatContainer.innerHTML += `
                <div class="chat-message ai" id="ai-loading">
                    ü§ñ Gemini ƒëang suy nghƒ©... <span class="loading"></span>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // T·∫°o context t·ª´ l·ªãch s·ª≠ chat
                let contextPrompt = 'B·∫°n l√† m·ªôt gi√°o vi√™n ti·∫øng Trung Ph·ªìn th·ªÉ (ƒê√†i Loan) chuy√™n nghi·ªáp v√† th√¢n thi·ªán. H√£y gi√∫p h·ªçc vi√™n h·ªçc ti·∫øng Trung m·ªôt c√°ch hi·ªáu qu·∫£, gi·∫£i th√≠ch r√µ r√†ng v·ªÅ ng·ªØ ph√°p, t·ª´ v·ª±ng, ph√°t √¢m v√† vƒÉn h√≥a. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.\n\n';
                
                // Th√™m l·ªãch s·ª≠ chat g·∫ßn ƒë√¢y
                if (chatHistory.length > 0) {
                    contextPrompt += 'L·ªãch s·ª≠ h·ªôi tho·∫°i:\n';
                    chatHistory.slice(-6).forEach(msg => {
                        contextPrompt += `${msg.role === 'user' ? 'H·ªçc vi√™n' : 'Gi√°o vi√™n'}: ${msg.content}\n`;
                    });
                    contextPrompt += '\n';
                }
                
                contextPrompt += `C√¢u h·ªèi m·ªõi c·ªßa h·ªçc vi√™n: ${message}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: contextPrompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1000
                        }
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
                }

                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ Gemini AI');
                }

                const aiMessage = data.candidates[0].content.parts[0].text;
                
                // X√≥a loading v√† hi·ªÉn th·ªã response
                document.getElementById('ai-loading').remove();
                chatContainer.innerHTML += `
                    <div class="chat-message ai">${aiMessage.replace(/\n/g, '<br>')}</div>
                `;
                
                // L∆∞u l·ªãch s·ª≠ chat
                chatHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: aiMessage }
                );
                
                // Gi·ªõi h·∫°n l·ªãch s·ª≠ chat (10 tin nh·∫Øn g·∫ßn nh·∫•t)
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }

            } catch (error) {
                console.error('Chat error:', error);
                document.getElementById('ai-loading').remove();
                
                let errorMessage = error.message;
                let helpText = '';
                
                if (errorMessage.includes('API_KEY_INVALID') || errorMessage.includes('API key not valid')) {
                    helpText = `
                        <br><br>
                        <strong>üîë Gemini API key kh√¥ng h·ª£p l·ªá!</strong><br><br>
                        <strong>üìç Gi·∫£i ph√°p:</strong><br>
                        1. V√†o C√†i ƒë·∫∑t v√† ki·ªÉm tra l·∫°i key<br>
                        2. T·∫°o key MI·ªÑN PH√ç t·∫°i: <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #007bff;">Google AI Studio</a><br>
                        3. Copy v√† d√°n v√†o C√†i ƒë·∫∑t
                    `;
                } else if (errorMessage.includes('quota') || errorMessage.includes('RESOURCE_EXHAUSTED')) {
                    helpText = `
                        <br><br>
                        <strong>‚è±Ô∏è ƒê√£ v∆∞·ª£t qu√° gi·ªõi h·∫°n!</strong><br><br>
                        Gemini 1.5 Flash free: 15 requests/ph√∫t<br>
                        ƒê·ª£i 1 ph√∫t v√† th·ª≠ l·∫°i!
                    `;
                } else if (errorMessage.includes('SAFETY') || errorMessage.includes('blocked')) {
                    helpText = '<br><br>‚ö†Ô∏è N·ªôi dung b·ªã ch·∫∑n b·ªüi b·ªô l·ªçc an to√†n. H√£y th·ª≠ c√¢u h·ªèi kh√°c!';
                } else {
                    helpText = '<br><br>Vui l√≤ng ki·ªÉm tra API key ho·∫∑c th·ª≠ l·∫°i sau.';
                }
                
                chatContainer.innerHTML += `
                    <div class="chat-message ai" style="background: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                        ‚ùå <strong>L·ªói:</strong> ${errorMessage}${helpText}
                    </div>
                `;
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // L∆∞u d·ªØ li·ªáu
        function saveLessons() {
            localStorage.setItem('lessons', JSON.stringify(lessons));
        }

        // Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
        init();
    </script>
</body>
</html>
